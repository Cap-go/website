---
slug: automatic-capacitor-ios-build-codemagic
title: Cr√©ation automatique d'un condensateur IOS avec Codemagic
description: >-
  Comment configurer un pipeline CI/CD pour votre application IOS Ionic √† l'aide
  de Codemagic et Codemagic en 5 minutes (2024)
author: Martin Donadieu
author_url: 'https://x.com/martindonadieu'
created_at: 2024-07-24T00:00:00.000Z
updated_at: 2024-07-24T00:00:00.000Z
head_image: /Codemagic_ios.webp
head_image_alt: Codemagic testflight illustration
tag: CI/CD
published: true
next_blog: automatic-capacitor-android-build-codemagic
locale: fr
---

## Livraison continue pour iOS √† l'aide de Codemagic


## Pr√©requis

Avant de poursuivre le tutoriel‚Ä¶

- Adh√©sion au programme pour d√©veloppeurs iOS
- Envie de lire üòÜ‚Ä¶

## Important concernant le prix

![Prix Codemagic Action](/price_codemagicwebp)

[https://codemagicio/pricing/](https://codemagicio/pricing/)

Le service est ¬´ _gratuit ¬ª_ jusqu‚Äô√† 500 minutes macOS M1/mois, selon la machine choisie  
Nous allons utiliser une machine **_macOS M1_**, vous pouvez voir sur la capture d'√©cran son prix et ses limites (tarifs d√®s la cr√©ation du tutoriel, ils pourraient subir des modifications dans le futur)

üî¥ **_Une fois pr√©venus des besoins et des tarifs, si vous le souhaitez, on continue‚Ä¶_**

> **_üì£_ Dans le post, nous supposons que nous avons l'application cr√©√©e dans iTunes Connect, nous avons les certificats de l'√©cosyst√®me Apple, tout sera configur√© par Codemagic !**

## Allons au d√©sordre üßëüèΩüíª

**√âtapes √† suivre dans le post**

1 _Utilisation de l'API App Store Connect avec Codemagic_
2 _Exigences_
3 _Cr√©ation d'une cl√© API App Store Connect_
4 _Utilisation d'une cl√© API App Store Connect_
5 _Copier les fichiers Fastline_
6 _Configurer Codemagic_

## 1\ Utilisation de l'API App Store Connect avec Codemagic

> √Ä partir de f√©vrier 2021, une authentification √† deux facteurs ou une v√©rification en deux √©tapes est requise pour que tous les utilisateurs puissent se connecter √† App Store Connect. Cette couche de s√©curit√© suppl√©mentaire pour votre identifiant Apple permet de garantir que vous √™tes la seule personne √† pouvoir acc√©der √† votre compte.  
> Depuis [Assistance Apple](https://developerapplecom/support/authentication/)

> La mise en route de match vous oblige √† r√©voquer vos certificats existants. Mais pas d'inqui√©tude, vous aurez directement le nouveau


### Exigences

Pour pouvoir utiliser l'API App Store Connect, Codemagic a besoin de **trois** √©l√©ments

1 identifiant de l'√©metteur
2 ID de cl√©
3 Fichier cl√© ou contenu cl√©

### Cr√©ation d'une cl√© API App Store Connect

Pour g√©n√©rer des cl√©s, vous devez disposer de l'autorisation d'administrateur dans App Store Connect. Si vous ne disposez pas de cette autorisation, vous pouvez diriger la personne concern√©e vers cet article et suivre les instructions suivantes.

1 ‚Äî Connectez-vous √† [App Store Connect](https://appstoreconnectapplecom/)

2 ‚Äî S√©lectionnez [Utilisateurs et acc√®s](https://appstoreconnectapplecom/access/users/)

![Acc√®s utilisateur App Store Connect](/select_user_accesswebp)

3 ‚Äî S√©lectionnez l'onglet Cl√©s API

![Cl√©s API App Store Connect](/user_access_keyswebp)

4 ‚Äî Cliquez sur G√©n√©rer une cl√© API ou sur le bouton Ajouter (+)

![Cr√©ation de cl√©s API App Store Connect](/user_accesswebp)

5 ‚Äî Entrez le nom de la cl√© et s√©lectionnez un niveau d'acc√®s. Nous vous recommandons de choisir les droits d'acc√®s ¬´¬†App Manager¬†¬ª, en savoir plus sur les autorisations de r√¥le du programme pour d√©veloppeurs Apple [ici] (https://helpapplecom/app-store-connect/#/deve5f9a89d7 )

![Les cl√©s API App Store Connect cr√©ent un nom](/gen_keywebp)

6 ‚Äî Cliquez sur G√©n√©rer

> **L'acc√®s √† une cl√© API ne peut pas √™tre limit√© √† des applications sp√©cifiques**

Le nom de la nouvelle cl√©, l'ID de la cl√©, un lien de t√©l√©chargement et d'autres informations apparaissent sur la page

![Cl√©s de t√©l√©chargement App Store Connect](/download_keywebp)

R√©cup√©rez les trois informations n√©cessaires ici¬†:
<1> ID du probl√®me  
<2> ID de cl√©  
<3> Cliquez sur ¬´ T√©l√©charger la cl√© API ¬ª pour t√©l√©charger votre cl√© priv√©e API Le lien de t√©l√©chargement n'appara√Æt que si la cl√© priv√©e n'a pas encore √©t√© t√©l√©charg√©e Apple ne conserve pas de copie de la cl√© priv√©e Vous ne pouvez donc la t√©l√©charger qu'une seule fois

> _üî¥_ Stockez votre cl√© priv√©e dans un endroit s√ªr Vous ne devez jamais partager vos cl√©s, stocker des cl√©s dans un r√©f√©rentiel de code ou inclure des cl√©s dans le code c√¥t√© client

### Ajout de la cl√© API App Store Connect √† Codemagic

1 Ouvrez les param√®tres de votre √©quipe Codemagic,
![S√©lectionner les int√©grations d'√©quipe](/select_teamwebp)
![Ouvrir l'√©quipe](/open_teamwebp)
S√©lectionnez les identit√©s de signature de code
![S√©lectionnez les identit√©s de signature de code](/select_code_signing_identitieswebp)
Et t√©l√©charger le certificat
![T√©l√©charger le certificat](/upload_certificatewebp)

2 Cliquez sur le bouton **Ajouter une cl√©**
3 Saisissez le ¬´ Nom de la cl√© API App Store Connect ¬ª. Il s'agit d'un nom lisible par l'homme pour la cl√© qui sera utilis√© pour faire r√©f√©rence √† la cl√© ult√©rieurement dans les param√®tres de l'application.
4 Saisissez les valeurs ¬´¬†Issuer ID¬†¬ª et ¬´¬†Key ID¬†¬ª
5 Cliquez sur **Choisissez unp8** ou faites glisser le fichier pour t√©l√©charger la cl√© API App Store Connect t√©l√©charg√©e pr√©c√©demment
6 Cliquez sur **Enregistrer**

_Maintenant, nous pouvons g√©rer Codemagic avec la cl√© API App Store Connect, super !_


## 2\ Cr√©er des certificats et des profils d'approvisionnement


#### Certificats

Ouvrez XCode et acc√©dez √† **Param√®tres** > **Comptes** > **Identifiant Apple** > **√âquipes** et s√©lectionnez votre √©quipe.

![Identit√©s de signature de code](/code_signing_identitieswebp)

Cliquez sur **G√©rer les certificats** > **+** et s√©lectionnez **Apple Distribution**

![Distribution Apple](/apple_distributionwebp)

Ensuite, vous pouvez cr√©er un nouveau certificat

Ensuite, vous devez acc√©der au trousseau pour t√©l√©charger le certificat sous forme de fichier ¬´¬†p12¬†¬ª

Pour ce faire, vous devez acc√©der au trousseau, passer au trousseau **login**, puis √† l'onglet **Mes certificats**.

![Mes certificats](/my_certificateswebp)

Ensuite, vous pouvez s√©lectionner le certificat que vous souhaitez t√©l√©charger (Regardez par la date du certificat)

Ensuite, faites un clic droit sur le certificat et s√©lectionnez **Exporter**

Choisissez le format de fichier **√âchange d'informations personnelles (p12)**

Cela t√©l√©chargera le certificat sous forme de fichier ¬´¬†p12¬†¬ª

#### Profils de provisionnement

Ouvrez [Apple Developer](https://developerapplecom/account/resources/profiles/list) et s√©lectionnez la bonne √©quipe

Cr√©ez ensuite un nouveau profil, en cliquant sur **++** 

![Cr√©er un nouveau profil](/create_new_profilewebp)

Et s√©lectionnez **App Store Connect** 

![S√©lectionnez App Store Connect](/select_app_store_connectwebp)

Ensuite, vous devez s√©lectionner la bonne application. Attention, vous ne pouvez pas utiliser de caract√®re g√©n√©rique, sinon la signature √©chouera.

![S√©lectionnez la bonne application](/select_appwebp)

S√©lectionnez le bon certificat que vous avez cr√©√© auparavant (recherchez la date d'expiration, il devrait √™tre le m√™me jour et le m√™me mois qu'aujourd'hui) et cliquez sur **Continuer**

![S√©lectionnez le bon certificat](/select_certificatewebp)

Entrez enfin le nom du profil et cliquez sur **G√©n√©rer** 

> Le nom sera utilis√© pour identifier le profil dans Codemagic

![G√©n√©rer le profil](/generate_profilewebp)

Vous pouvez t√©l√©charger le profil sous forme de fichier ¬´¬†mobileprovision¬†¬ª

![T√©l√©charger le profil](/download_profilewebp)


### Ajout du certificat de signature de code

Codemagic vous permet de t√©l√©charger des certificats de signature de code sous forme d'archives PKCS#12 contenant √† la fois le certificat et la cl√© priv√©e n√©cessaire pour l'utiliser. Lors du t√©l√©chargement, Codemagic vous demandera de fournir le mot de passe du certificat (si le certificat est prot√©g√© par mot de passe) ainsi qu'un **Nom de r√©f√©rence** unique, qui peut ensuite √™tre utilis√© dans la configuration `codemagicyaml` pour r√©cup√©rer le fichier sp√©cifique

- T√©l√©charger le certificat
- G√©n√©rer un nouveau certificat
- R√©cup√©rer depuis le portail des d√©veloppeurs

1 Ouvrez les param√®tres de votre √©quipe Codemagic, acc√©dez √† **param√®tres codemagicyaml** > **Identit√©s de signature de code**
2 Ouvrez l'onglet **Certificats iOS**
3 T√©l√©chargez le fichier de certificat en cliquant sur **Choisissez un fichier p12 ou pem** ou en le faisant glisser dans le cadre indiqu√©
4 Saisissez le **Mot de passe du certificat** et choisissez un **Nom de r√©f√©rence**.
5 Cliquez sur **Ajouter un certificat**

### Ajout du profil de provisionnement

Codemagic vous permet de t√©l√©charger un profil d'approvisionnement √† utiliser pour l'application ou de r√©cup√©rer un profil sur le portail des d√©veloppeurs Apple.

Le type de profil, l'√©quipe, l'identifiant du bundle et la date d'expiration sont affich√©s pour chaque profil ajout√© aux identit√©s de signature de code. De plus, Codemagic vous indiquera si un certificat de signature de code correspondant est disponible dans Identit√©s de signature de code (une coche verte dans la zone **Certificat). ** champ) ou pas

## 3\ Configurer Codemagic

**Configurer les secrets Codemagic**

Vous √™tes-vous d√©j√† demand√© d'o√π viennent les valeurs de ¬´¬†ENV¬†¬ª¬†? Eh bien, ce n‚Äôest plus un secret ‚Äì cela vient du secret de votre projet ü§¶


## **4\ Configurer le fichier de workflow Codemagic**

Cr√©ez un fichier nomm√© `codemagicyml` √† la racine de votre projet et ajoutez ce qui suit

```yaml
workflows:
  ionic-capacitor-ios-workflow:
    name: Capacitor iOS Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    integrations:
      app_store_connect: CodeMagic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: YOUR_BUNDLE_IDENTIFIER
      vars:
        XCODE_WORKSPACE: ios/App/App.xcworkspace
        XCODE_SCHEME: App
        APP_STORE_APP_ID: YOUR_APP_STORE_APP_ID
      node: v20.14.0
      xcode: 15.4
      cocoapods: default
    triggering:
      events:
        - tag
      tag_patterns:
        - pattern: '*'
          include: true
    scripts:
      - name: Install dependencies
        script: |
          npm install
      - name: Cocoapods installation
        script: |
          cd ios/App && pod install
      - name: Update dependencies and copy web assets to native project
        script: |
          npm run build
          npx cap sync ios
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Increment build number
        script: |
          cd $CM_BUILD_DIR/ios/App
          LATEST_BUILD_NUMBER=$(app-store-connect get-latest-app-store-build-number "$APP_ID")
          agvtool new-version -all $(($LATEST_BUILD_NUMBER + 1))
      - name: Build ipa for distribution
        script: |
          xcode-project build-ipa \
            --workspace "$XCODE_WORKSPACE" \
            --scheme "$XCODE_SCHEME"
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
    publishing:
      email:
        recipients:
          - YOUR_EMAIL
        notify:
          success: true # To not receive a notification when a build succeeds
          failure: false # To not receive a notification when a build fails
      app_store_connect:
        auth: integration
        # Configuration related to TestFlight (optional)
        # Note: This action is performed during post-processing.
        submit_to_testflight: true
        # Configuration related to App Store (optional)
        # Note: This action is performed during post-processing.
        submit_to_app_store: false

```

Ce workflow doit √™tre d√©clench√© manuellement ou apr√®s chaque _tag_ GitHub, si vous devez automatiser la balise, veuillez vous r√©f√©rer √† [Cr√©ation et publication automatiques avec les actions GitHub](/blog/automatic-build-and-release-with-github-actions/) d'abordEnsuite, ce workflow extraira vos d√©p√¥ts NodeJS, les installera et cr√©era votre application JavaScript.

> Chaque fois que vous envoyez un nouveau tag, une release sera construite dans TestFlight

Votre application n'a pas besoin d'utiliser Ionic, seule la base Capacitor est obligatoire, elle peut avoir l'ancien module Cordova, mais le plugin Capacitor JS doit √™tre pr√©f√©r√©

## 5\ D√©clencher le workflow


**D√©clenchez le workflow**

Poussez les nouveaux commits vers la branche ¬´¬†main¬†¬ª ou ¬´¬†developement¬†¬ª pour d√©clencher le workflow

![D√©marr√© avec commit](/build_resultwebp)

Apr√®s quelques minutes, la version devrait √™tre disponible dans votre tableau de bord App Store Connect

![Tableau de bord Testflight](/testflight_appwebp)

## D√©marrer manuellement

Vous pouvez d√©marrer le workflow manuellement 

S√©lectionnez d'abord l'application que vous souhaitez cr√©er, puis cliquez sur **D√©marrer une nouvelle version**

![S√©lectionner l'application](/select_app_codemagicwebp)

S√©lectionnez ensuite la branche que vous souhaitez cr√©er

![S√©lectionner une branche](/select_branchwebp)

Et cliquez sur **D√©marrer une nouvelle build**

Alors allez-y, la liste de construction

![Construire la liste](/build_listwebp)

Et cliquez sur le build pour voir le r√©sultat

![R√©sultat de construction](/build_resultwebp)

## Peut √™tre d√©ploy√© √† partir d'une machine locale

Oui, vous pouvez, et c'est sans effort

Vous pouvez utiliser Xcode pour cr√©er et signer votre application, comme toujours

### Merci

Ce blog est bas√© sur les articles suivants :
- [Livraison continue pour IOS √† l'aide des actions Codemagic et GitHub](https://litoariasmediumcom/continuous-delivery-for-ios-using-Codemagic-and-github-actions-edf62ee68ecc/)
- [Documentation Codemagic](https://docsCodemagictools/app-store-connect-api/)
- [Ce message GitHub de @mrogunlana](https://githubcom/Codemagic-community/Codemagic-plugin-ionic/issues/63/#issuecomment-1074328057)