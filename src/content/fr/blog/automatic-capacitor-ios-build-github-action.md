---
slug: automatic-capacitor-ios-build-github-action
title: >-
  Construction automatique du condensateur IOS avec actions GitHub avec
  certificat
description: >-
  Comment configurer un pipeline CI/CD pour votre application IOS Ionic √† l'aide
  de Fastlane et des actions GitHub en 5 minutes (2024)
author: Martin Donadieu
author_url: 'https://x.com/martindonadieu'
created_at: 2024-08-04T00:00:00.000Z
updated_at: 2024-08-04T00:00:00.000Z
head_image: /fastlane_ios.webp
head_image_alt: Fastlane testflight GitHub action illustration
tag: CI/CD
published: true
next_blog: automatic-capacitor-android-build-github-action
---

## Livraison continue pour iOS √† l'aide des actions et du certificat Fastlane et GitHub


## Pr√©requis

Avant de poursuivre le tutoriel‚Ä¶

- Assurez-vous d'avoir Fastlane [install√©](https://docsfastlanetools/) sur votre machine de d√©veloppement
- Adh√©sion au programme pour d√©veloppeurs iOS
- Envie de lire üòÜ‚Ä¶

## Important concernant le prix

![Prix de l'action GitHub](/price_github_actionswebp)

[https://githubcom/features/actions](https://githubcom/features/actions/)

Le service est '_gratuit'_ dans la limite, selon la machine choisie  
Nous allons utiliser une machine **_macOS_**, vous pouvez voir sur la capture d'√©cran son prix et ses limites (tarifs d√®s la cr√©ation du tutoriel, ils pourraient subir des modifications dans le futur)

üî¥ **_Une fois pr√©venus des besoins et des tarifs, si vous le souhaitez, on continue‚Ä¶_**

> **_üì£_ Dans le post nous supposons que nous avons l'application cr√©√©e dans iTunes connect, nous avons les certificats de l'√©cosyst√®me Apple, tout sera copi√© par Fastlane !**

## Allons au d√©sordre üßëüèΩüíª

**√âtapes √† suivre dans le post**

1 _Utilisation de l'API App Store Connect avec Fastlane_
2 _Exigences_
3 _Cr√©ation d'une cl√© API App Store Connect_
4 _Utilisation d'une cl√© API App Store Connect_
5 _Copier les fichiers Fastline_
6 _Configurer les actions GitHub_


## 1 Utilisation de l'API App Store Connect avec Fastlane

> √Ä partir de f√©vrier 2021, une authentification √† deux facteurs ou une v√©rification en deux √©tapes est requise pour que tous les utilisateurs puissent se connecter √† App Store Connect. Cette couche de s√©curit√© suppl√©mentaire pour votre identifiant Apple permet de garantir que vous √™tes la seule personne √† pouvoir acc√©der √† votre compte.  
> Depuis [Assistance Apple](https://developerapplecom/support/authentication/)

## Exigences

Pour pouvoir utiliser l'API App Store Connect, Fastlane a besoin de **trois** √©l√©ments¬†:

1 identifiant de l'√©metteur
2 ID de cl√©
3 Fichier cl√© ou contenu cl√©

## Cr√©ation d'une cl√© API App Store Connect

Pour g√©n√©rer des cl√©s, vous devez disposer de l'autorisation d'administrateur dans App Store Connect. Si vous ne disposez pas de cette autorisation, vous pouvez diriger la personne concern√©e vers cet article et suivre les instructions suivantes.

1 ‚Äî Connectez-vous √† [App Store Connect](https://appstoreconnectapplecom/)

2 ‚Äî S√©lectionnez [Utilisateurs et acc√®s](https://appstoreconnectapplecom/access/users/)

![Acc√®s utilisateur App Store Connect](/select_user_accesswebp)

3 ‚Äî S√©lectionnez l'onglet Cl√©s API

![Cl√©s API App Store Connect](/user_access_keyswebp)

4 ‚Äî Cliquez sur G√©n√©rer une cl√© API ou sur le bouton Ajouter (+)

![Cr√©ation de cl√©s API App Store Connect](/user_accesswebp)

5 ‚Äî Entrez un nom pour la cl√©. Le nom est uniquement √† titre de r√©f√©rence et ne fait pas partie de la cl√© elle-m√™me.

![Les cl√©s API App Store Connect cr√©ent un nom](/gen_keywebp)

6 ‚Äî Sous Acc√®s, s√©lectionnez le r√¥le de la cl√©. Les r√¥les qui s'appliquent aux cl√©s sont les m√™mes que ceux qui s'appliquent aux utilisateurs de votre √©quipe Voir [autorisations de r√¥le](https://helpapplecom/app-store-connect/#/deve5f9a89d7/ ) Nous vous recommandons de s√©lectionner **Gestion des applications**


7 ‚Äî Cliquez sur G√©n√©rer

> **L'acc√®s √† une cl√© API ne peut pas √™tre limit√© √† des applications sp√©cifiques**

Le nom de la nouvelle cl√©, l'ID de la cl√©, un lien de t√©l√©chargement et d'autres informations apparaissent sur la page

![Cl√©s de t√©l√©chargement App Store Connect](/download_keywebp)

Vous pouvez r√©cup√©rer les trois informations n√©cessaires ici  
<1> ID du probl√®me  
<2> ID de cl√©  
<3> Cliquez sur "T√©l√©charger la cl√© API" pour t√©l√©charger votre cl√© priv√©e API Le lien de t√©l√©chargement n'appara√Æt que si la cl√© priv√©e n'a pas encore √©t√© t√©l√©charg√©e Apple ne conserve pas de copie de la cl√© priv√©e Vous ne pouvez donc la t√©l√©charger qu'une seule fois

> _üî¥_ Stockez votre cl√© priv√©e dans un endroit s√ªr Vous ne devez jamais partager vos cl√©s, stocker des cl√©s dans un r√©f√©rentiel de code ou inclure des cl√©s dans le code c√¥t√© client

## Utilisation d'une cl√© API App Store Connect

Le fichier de cl√© API (fichier p8 que vous t√©l√©chargez), l'ID de cl√© et l'ID d'√©metteur sont n√©cessaires pour cr√©er le jeton JWT pour l'autorisation. Il existe plusieurs fa√ßons de saisir ces informations dans Fastlane √† l'aide de la nouvelle action de Fastlane, `app_store_connect_api_key ` Vous pouvez d√©couvrir d'autres m√©thodes dans la [documentation Fastlane](https://docsfastlanetools/actions/app_store_connect_api_key/)Je montre cette m√©thode parce que je pense que c'est le moyen le plus simple de travailler avec la plupart des CI, o√π vous pouvez d√©finir des variables d'environnement.

_Maintenant, nous pouvons g√©rer Fastlane avec la cl√© API App Store Connect, super !_

### Cr√©er des certificats et des profils de provisionnement

#### Certificats

Ouvrez XCode et acc√©dez √† **Param√®tres** > **Comptes** > **Identifiant Apple** > **√âquipes** et s√©lectionnez votre √©quipe.

![Identit√©s de signature de code](/code_signing_identitieswebp)

Cliquez sur **G√©rer les certificats** > **+** et s√©lectionnez **Apple Distribution**

![Distribution Apple](/apple_distributionwebp)

Ensuite, vous pouvez cr√©er un nouveau certificat

Ensuite, vous devez acc√©der au trousseau pour t√©l√©charger le certificat sous forme de fichier ¬´¬†p12¬†¬ª

Pour ce faire, vous devez acc√©der au trousseau, passer au trousseau **login**, puis √† l'onglet **Mes certificats**.

![Mes certificats](/my_certificateswebp)

Ensuite, vous pouvez s√©lectionner le certificat que vous souhaitez t√©l√©charger (Regardez par la date du certificat)

Ensuite, faites un clic droit sur le certificat et s√©lectionnez **Exporter**

Choisissez le format de fichier **√âchange d'informations personnelles (p12)**

Cela t√©l√©chargera le certificat sous forme de fichier ¬´¬†p12¬†¬ª

#### Profils de provisionnement

Ouvrez [Apple Developer](https://developerapplecom/account/resources/profiles/list) et s√©lectionnez la bonne √©quipe

Cr√©ez ensuite un nouveau profil, en cliquant sur **++** 

![Cr√©er un nouveau profil](/create_new_profilewebp)

Et s√©lectionnez **App Store Connect** 

![S√©lectionnez App Store Connect](/select_app_store_connectwebp)

Ensuite, vous devez s√©lectionner la bonne application. Attention, vous ne pouvez pas utiliser de caract√®re g√©n√©rique, sinon la signature √©chouera.

![S√©lectionnez la bonne application](/select_appwebp)

S√©lectionnez le bon certificat que vous avez cr√©√© auparavant (recherchez la date d'expiration, il devrait √™tre le m√™me jour et le m√™me mois qu'aujourd'hui) et cliquez sur **Continuer**

![S√©lectionnez le bon certificat](/select_certificatewebp)

Entrez enfin le nom du profil et cliquez sur **G√©n√©rer** 

> Le nom sera utilis√© pour identifier le profil dans Fastlane, sous la valeur de `APPLE_PROFILE_NAME`

![G√©n√©rer le profil](/generate_profilewebp)

Vous pouvez t√©l√©charger le profil sous forme de fichier ¬´¬†mobileprovision¬†¬ª

![T√©l√©charger le profil](/download_profilewebp)


### Cr√©ation de secrets GitHub pour votre certificat et votre profil d'approvisionnement

Le processus de signature implique le stockage des certificats et des profils d'approvisionnement, leur transfert vers le programme d'ex√©cution, leur importation dans le trousseau du programme d'ex√©cution et leur utilisation dans votre build.

Cr√©ez des secrets dans votre r√©f√©rentiel ou organisation pour les √©l√©ments suivants¬†:

- Votre certificat de signature Apple
    
    - Ceci est votre fichier de certificat `p12`. Pour plus d'informations sur l'exportation de votre certificat de signature depuis Xcode, consultez la [documentation Xcode](https://helpapplecom/xcode/mac/current/#/dev154b28f09)
        
    - Vous devez convertir votre certificat en Base64 lorsque vous l'enregistrez en tant que secret. Dans cet exemple, le secret est nomm√© `BUILD_CERTIFICATE_BASE64`
        
    - Utilisez la commande suivante pour convertir votre certificat en Base64 et copiez-le dans votre presse-papiers¬†:
        
        ```shell
        base64 -i BUILD_CERTIFICATE.p12 | pbcopy
        ```
        
- Le mot de passe de votre certificat de signature Apple
    
    - Dans cet exemple, le secret est nomm√© `P12_PASSWORD`
- Votre profil d'approvisionnement Apple
    
    - Pour plus d'informations sur l'exportation de votre profil d'approvisionnement depuis Xcode, consultez la [documentation Xcode](https://helpapplecom/xcode/mac/current/#/deva899b4fe5)
        
    - Vous devez convertir votre profil d'approvisionnement en Base64 lorsque vous l'enregistrez en tant que secret. Dans cet exemple, le secret est nomm√© ¬´ BUILD_PROVISION_PROFILE_BASE64 ¬ª.
        
    - Utilisez la commande suivante pour convertir votre profil d'approvisionnement en Base64 et copiez-le dans votre presse-papiers¬†:
        
        ```shell
        base64 -i PROVISIONING_PROFILE.mobileprovision | pbcopy
        ```


## 2\ Copier les fichiers Fastline

Fastlane est une biblioth√®que Ruby cr√©√©e pour automatiser les t√¢ches courantes de d√©veloppement mobile. En utilisant Fastlane, vous pouvez configurer des ¬´ voies ¬ª personnalis√©es qui regroupent une s√©rie d'¬´ actions ¬ª qui effectuent des t√¢ches que vous effectueriez normalement avec Android Studio. Vous pouvez faire beaucoup de choses avec Fastlane, mais pour les besoins de ce didacticiel, nous n'utiliserons qu'une poign√©e d'actions principalesCr√©ez un dossier Fastlane √† la racine de votre projet et copiez les fichiers suivants¬†:
Fichier rapide
```ruby
platform :ios do
  desc 'Export ipa and submit to TestFlight'
  lane :beta do
    keychain_info = { keychain_name: "ios-build-#{Time.now.to_i}.keychain", keychain_password: SecureRandom.uuid }
    
    begin
      setup_signing(keychain_info)
      bump_build_number
      build_app_with_signing(keychain_info)
      submit_to_testflight
    ensure
      cleanup_keychain(keychain_info)
    end
  end

  private_lane :setup_signing do |options|
    create_keychain(
      name: options[:keychain_name],
      password: options[:keychain_password],
      unlock: true,
      timeout: 0,
      lock_when_sleeps: false, 
      add_to_search_list: true
    )
    import_cert(options)
    install_profile
    update_project_settings
  end

  lane :bump_build_number do
		file = File.read('../package.json')
		data_hash = JSON.parse(file)
		api_key = app_store_connect_api_key(
      key_id: ENV['APPLE_KEY_ID'],
      issuer_id: ENV['APPLE_ISSUER_ID'],
      key_content: Base64.decode64(ENV['APPLE_KEY_CONTENT']),
      duration: 1200,
      in_house: false
    )
		build_num = app_store_build_number(
      api_key: api_key,
			app_identifier: ENV['BUNDLE_IDENTIFIER'],
			live: false
    )
		build_num = build_num + 1
		UI.message("Bumped build number to #{build_num}")
		increment_build_number(
			build_number: build_num,
			xcodeproj: "./ios/App/App.xcodeproj",
			skip_info_plist: true
		)
	end

  private_lane :import_cert do |options|
    cert_path = "#{Dir.tmpdir}/build_certificate.p12"
    File.write(cert_path, Base64.decode64(ENV['BUILD_CERTIFICATE_BASE64']))
    import_certificate(
      certificate_path: cert_path,
      certificate_password: ENV['P12_PASSWORD'] || "",
      keychain_name: options[:keychain_name],
      keychain_password: options[:keychain_password],
      log_output: true
    )
    File.delete(cert_path)
  end  
  
  private_lane :cleanup_keychain do |options|
    delete_keychain(
      name: options[:keychain_name]
    )
  end  

  private_lane :install_profile do
    profile_path = "#{Dir.tmpdir}/build_pp.mobileprovision"
    File.write(profile_path, Base64.decode64(ENV['BUILD_PROVISION_PROFILE_BASE64']))
    UI.user_error!("Failed to create provisioning profile at #{profile_path}") unless File.exist?(profile_path)
    ENV['PROVISIONING_PROFILE_PATH'] = profile_path
    install_provisioning_profile(path: profile_path)
    File.delete(profile_path)
  end

  private_lane :update_project_settings do
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "./ios/App/App.xcodeproj",
      code_sign_identity: "iPhone Distribution",
      profile_name: ENV['APPLE_PROFILE_NAME'],
      bundle_identifier: ENV['BUNDLE_IDENTIFIER'],
      team_id: ENV['APP_STORE_CONNECT_TEAM_ID']
    )
    update_project_team(
      path: "./ios/App/App.xcodeproj",
      teamid: ENV['APP_STORE_CONNECT_TEAM_ID']
    )
  end

  private_lane :build_app_with_signing do |options|
    unlock_keychain(
      path: options[:keychain_name],
      password: options[:keychain_password],
      set_default: false
    )
    build_app(
      workspace: "./ios/App/App.xcworkspace",
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      output_name: "App.ipa",
      export_options: {
        provisioningProfiles: {
          ENV['BUNDLE_IDENTIFIER'] => ENV['APPLE_PROFILE_NAME']
        }
      },
      xcargs: "-verbose",
      buildlog_path: "./build_logs",
      export_xcargs: "-allowProvisioningUpdates",
    )
  end   

  private_lane :submit_to_testflight do
    api_key = app_store_connect_api_key(
      key_id: ENV['APPLE_KEY_ID'],
      issuer_id: ENV['APPLE_ISSUER_ID'],
      key_content: Base64.decode64(ENV['APPLE_KEY_CONTENT']),
      duration: 1200,
      in_house: false
    )
    pilot(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false,
      ipa: "./App.ipa"
    )
  end
end
```

## **Traitement de construction**

Dans GitHub Actions, **vous √™tes factur√© en fonction des minutes** que vous avez utilis√©es pour ex√©cuter votre flux de travail CI/CD. D'apr√®s l'exp√©rience, il faut environ 10 √† 15 minutes avant qu'une build puisse √™tre trait√©e dans App Store Connect.

Pour les projets priv√©s, le co√ªt estim√© par build peut aller jusqu'√† **008$/min x 15 minutes = 12$**, ou plus, selon la configuration ou les d√©pendances de votre projet.

Si vous partagez les m√™mes pr√©occupations concernant la tarification que moi pour les projets priv√©s, vous pouvez garder `skip_waiting_for_build_processing` sur `true`

Quel est le pi√®ge ? Vous devez mettre √† jour manuellement la conformit√© de votre application dans App Store Connect une fois la build trait√©e, pour pouvoir distribuer la build √† vos utilisateurs.

Il s'agit simplement d'un param√®tre facultatif √† mettre √† jour si vous souhaitez √©conomiser sur les minutes de construction pour les projets priv√©s. Pour les projets gratuits, cela ne devrait pas poser de probl√®me du tout Voir [tarification](https://githubcom/pricing/)


## 3\ Configurer les actions GitHub

**Configurer les secrets GitHub**

Vous √™tes-vous d√©j√† demand√© d'o√π viennent les valeurs de ¬´¬†ENV¬†¬ª¬†? Eh bien, ce n‚Äôest plus un secret ‚Äì cela vient du secret de votre projet ü§¶

![D√©finir les secrets GitHub](/github_secetswebp)

1\ `APP_STORE_CONNECT_TEAM_ID` - l'ID de votre √©quipe App Store Connect si vous faites partie de plusieurs √©quipes

2\ `PROVISIONING_PROFILE_SPECIFIER` - `match AppStore <YOUR_APP_BUNDLE_IDENTIFIER>`, par exemple `match AppStore comdomainblablademo`

3\ `BUILD_CERTIFICATE_BASE64` - Certificat encod√© en Base64

4\ `BUILD_PROVISION_PROFILE_BASE64` - Profil d'approvisionnement encod√© en Base64

5\ `BUNDLE_IDENTIFIER` - l'identifiant du bundle de votre application

6\ `APPLE_KEY_ID` ‚Äî Cl√© API App Store Connect üî∫ID de cl√©

7\ `APPLE_ISSUER_ID` ‚Äî Cl√© API App Store Connect üî∫Identifiant de l'√©metteur

8\ `APPLE_KEY_CONTENT` ‚Äî Cl√© API App Store Connect üî∫ Contenu cl√© de _p8_, [v√©rifiez-le](https://githubcom/fastlane/fastlane/issues/18655/#issuecomment-881764901)

## **4\ Configurer le fichier de workflow GitHub**

Cr√©er un r√©pertoire de workflow GitHub

```
cd .github/workflows
```

Dans le dossier `workflow`, cr√©ez un fichier nomm√© `build-upload-isyml` et ajoutez ce qui suit

```yaml
name: Build source code on ios

on:
  push:
    tags:
      - '*'

jobs:
  build_ios:
    runs-on: macOS-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        id: install_code
        run: npm ci
      - name: Build
        id: build_code
        run: npm run build
      - name: Build
        id: build_code
        run: npm run mobile
      - uses: actions/cache@v3
        with:
          path: ios/App/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-
      - name: Sync
        id: sync_code
        run: npx cap sync
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
      - uses: maierj/fastlane-action@v3.1.0
        env:
          APP_STORE_CONNECT_TEAM_ID: ${{ secrets.APP_STORE_CONNECT_TEAM_ID }}
          BUNDLE_IDENTIFIER: ${{ secrets.BUNDLE_IDENTIFIER }}
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
          APPLE_ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
          APPLE_KEY_CONTENT: ${{ secrets.APPLE_KEY_CONTENT }}
          APPLE_PROFILE_NAME: ${{ secrets.APPLE_PROFILE_NAME }}
        with:
          lane: ios beta
      - name: Upload release bundle
        uses: actions/upload-artifact@v4
        with:
          name: ios-release
          path: ./App.ipa
          retention-days: 10
```

Ce workflow doit √™tre d√©clench√© apr√®s chaque _tag_ GitHub. Si vous devez automatiser la balise, veuillez d'abord vous r√©f√©rer √† [Cr√©ation et publication automatiques avec les actions GitHub](/blog/automatic-build-and-release-with-github-actions/)

Ensuite, ce workflow extraira vos d√©p√¥ts NodeJS, les installera et cr√©era votre application JavaScript.

> Chaque fois que vous envoyez un nouveau commit, une version sera construite dans TestFlight

Votre application n'a pas besoin d'utiliser Ionic, seule la base Capacitor est obligatoire, elle peut avoir l'ancien module Cordova, mais le plugin Capacitor JS doit √™tre pr√©f√©r√©

## 5\ D√©clencher le workflow

**Cr√©er un commit**

Faites un _commit_, vous devriez voir le workflow actif dans le r√©f√©rentiel

**D√©clenchez le workflow**

Poussez les nouveaux commits vers la branche ¬´¬†main¬†¬ª ou ¬´¬†developement¬†¬ª pour d√©clencher le workflow

![D√©marr√© avec commit](/cd_startedwebp)

Apr√®s quelques minutes, la version devrait √™tre disponible dans votre tableau de bord App Store Connect

![Tableau de bord Testflight](/testflight_appwebp)

## Peut-on d√©ployer √† partir d'une machine locale¬†?

Oui, vous pouvez, et c'est sans effort

Vous pouvez utiliser Xcode pour cr√©er et signer votre application, comme toujours

### Merci

Ce blog est bas√© sur les articles suivants :
- [Livraison continue pour IOS √† l'aide des actions Fastlane et GitHub](https://litoariasmediumcom/continuous-delivery-for-ios-using-fastlane-and-github-actions-edf62ee68ecc/)
- [Documentation Fastlane](https://docsfastlanetools/app-store-connect-api/)
- [Ce message GitHub de @mrogunlana](https://githubcom/fastlane-community/fastlane-plugin-ionic/issues/63/#issuecomment-1074328057)
- [Cette documentation GitHub](https://docsgithubcom/en/actions/deployment/deploying-xcode-applications/installing-an-apple-certificate-on-macos-runners-for-xcode-development)