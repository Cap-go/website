---
title: Integración con GitLab CI/CD
locale: es
description: "Aprenda cómo integrar las Actualizaciones en Vivo de Capgo con GitLab CI/CD para el despliegue automatizado de las actualizaciones de su aplicación."
sidebar:
  order: 2
---

import { Aside, Steps } from '@astrojs/starlight/components';

Integre las Actualizaciones en Vivo de Capgo con GitLab CI/CD para desplegar automáticamente las actualizaciones de su aplicación cada vez que realice cambios en el código. Esta guía cubre la configuración de flujos de trabajo automatizados de construcción, pruebas y despliegue.

## Requisitos previos

Antes de configurar la integración con GitLab CI/CD, asegúrese de tener:

- Una cuenta de GitLab con un repositorio de proyecto
- Una cuenta de Capgo con una aplicación configurada
- Node.js y npm/yarn configurados en su proyecto

## Configuración de GitLab CI/CD

### Paso 1: Configurar Variables de entorno

Primero, Configurar las Variables necesarias en su proyecto de GitLab:

<Steps>

1. Navegue a su proyecto de GitLab
2. Vaya a **Configuración** → **CI/CD** → **Variables**
3. Agregue las siguientes Variables:

</Steps>

| Nombre de Variable | Valor | Protegida | Enmascarada |
|---------------|-------|-----------|--------|
| `CAPGO_TOKEN` | Su token de API de Capgo | ✅ Sí | ✅ Sí |

<Aside type="tip">

Obtenga su token de API de Capgo desde [console.capgo.app/apikeys](https://console.capgo.app/apikeys). El ID de su aplicación ya está configurado en su archivo `capacitor.config.ts`.

</Aside>

## Simple

Configuración básica que despliega a producción en cada push a la rama principal:

```yaml
# .gitlab-ci.yml - Configuración simple
image: node:22

stages:
  - build
  - deploy

variables:
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

build:
  stage: build
  script:
    - npm ci
    - npm run test
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - main

deploy_production:
  stage: deploy
  script:
    - npm install -g @capgo/cli
    - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel production
    # Para cargas cifradas, agregar: --key-data-v2 "$CAPGO_PRIVATE_KEY"
  dependencies:
    - build
  only:
    - main
```

## Avanzado

### Despliegues de ramas de características

Despliegue ramas de características a canales de prueba para revisión y Pruebas:

```yaml
# Despliegue de rama de características
deploy_feature:
  stage: deploy
  script:
    - npm install -g @capgo/cli
    - CHANNEL_NAME="feature-$(echo $CI_COMMIT_REF_NAME | sed 's/[^a-zA-Z0-9-]/-/g')"
    - npx @capgo/cli channel create $CHANNEL_NAME --apikey $CAPGO_TOKEN || true
    - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel $CHANNEL_NAME
  dependencies:
    - build
  only:
    - /^feature\/.*$/
  environment:
    name: feature/$CI_COMMIT_REF_NAME
    url: https://your-app.com/channels/$CHANNEL_NAME
```

<Aside type="tip">

**Pruebas con Canales**: Después de desplegar a un canal de características, puede probar la actualización en su aplicación configurándola para usar ese canal específico. Aprenda más sobre [configurar canales en su aplicación](/docs/live-updates/channels/#configuring-the-channel-in-your-app).

</Aside>

### Uso de cifrado

Si está usando la [función de cifrado de Capgo](/docs/live-updates/encryption/), deberá almacenar su clave privada de forma segura en su entorno de CI/CD.

Después de [configurar las claves de cifrado](/docs/live-updates/encryption/#setting-up-encryption) localmente, agregue su clave privada a las Variables de GitLab:

```shell
# Mostrar el contenido de su clave privada (copiar esta salida)
cat .capgo_key_v2
```

Agregue este contenido como `CAPGO_PRIVATE_KEY` en las Variables del proyecto de GitLab (marque como protegida y enmascarada), luego úselo en pipelines:

```yaml
# Desplegar con cifrado
deploy_production:
  script:
    - npm install -g @capgo/cli
    - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --key-data-v2 "$CAPGO_PRIVATE_KEY" --channel production
```

<Aside type="caution">

**Mejores prácticas de seguridad:**
- Nunca confirme el archivo `.capgo_key_v2` en el control de versiones
- Almacene la clave privada solo en la gestión segura de secretos de CI/CD
- Usar claves diferentes para diferentes entornos

</Aside>

### Configuración multicanal

Para obtener información completa sobre la configuración y gestión de múltiples canales de despliegue, consulte la [documentación de Canales](/docs/live-updates/channels/).

Configuración completa con múltiples entornos y despliegues de merge request:

```yaml
# .gitlab-ci.yml - Configuración avanzada multicanal
image: node:22

stages:
  - build
  - deploy

variables:
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

# Etapa de construcción
build:
  stage: build
  script:
    - npm ci
    - npm run test
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 24 hours

# Desplegar a canal de desarrollo
deploy_development:
  stage: deploy
  script:
    - npm install -g @capgo/cli
    - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel development
  dependencies:
    - build
  only:
    - develop
  environment:
    name: development

# Desplegar merge requests a canales de prueba
deploy_mr:
  stage: deploy
  script:
    - npm install -g @capgo/cli
    - CHANNEL_NAME="mr-$CI_MERGE_REQUEST_IID"
    - npx @capgo/cli channel create $CHANNEL_NAME --apikey $CAPGO_TOKEN || true
    - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel $CHANNEL_NAME
  dependencies:
    - build
  only:
    - merge_requests
  environment:
    name: review/$CI_MERGE_REQUEST_IID
    url: https://your-app.com/channels/mr-$CI_MERGE_REQUEST_IID
    on_stop: cleanup_mr

# Limpiar canales de MR cuando se cierra el MR
cleanup_mr:
  stage: deploy
  script:
    - npm install -g @capgo/cli
    - npx @capgo/cli channel delete mr-$CI_MERGE_REQUEST_IID --apikey $CAPGO_TOKEN || true
  when: manual
  environment:
    name: review/$CI_MERGE_REQUEST_IID
    action: stop
  only:
    - merge_requests

# Desplegar a staging
deploy_staging:
  stage: deploy
  script:
    - npm install -g @capgo/cli
    - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel staging
  dependencies:
    - build
  only:
    - develop
  environment:
    name: staging

# Desplegar a producción
deploy_production:
  stage: deploy
  script:
    - npm install -g @capgo/cli
    - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel production
  dependencies:
    - build
  only:
    - main
  environment:
    name: production
```

### Multi-entorno con aprobación manual

Para despliegues de producción que requieren aprobación manual:

```yaml
deploy_production:
  stage: deploy
  script:
    - npm install -g @capgo/cli
    - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel production
  dependencies:
    - build
  only:
    - main
  when: manual
  environment:
    name: production
```

### Estrategia de despliegue basada en ramas

Despliegue diferentes ramas a los canales apropiados automáticamente:

```yaml
# Despliegue dinámico de canal basado en rama
deploy:
  stage: deploy
  script:
    - npm install -g @capgo/cli
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        CHANNEL="production"
      elif [ "$CI_COMMIT_REF_NAME" = "develop" ]; then
        CHANNEL="staging"
      else
        CHANNEL="development"
      fi
    - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel $CHANNEL
  dependencies:
    - build
  environment:
    name: $CHANNEL
```

## Mejores prácticas de seguridad

### Variables protegidas

<Steps>

1. **Marcar Variables sensibles**: Siempre marque los tokens de API como protegidos y enmascarados
2. **Protección de rama**: Usar Variables protegidas para despliegues de producción
3. **Control de acceso**: Limite el acceso de Variables solo a mantenedores
4. **Rotación regular**: Rote los tokens de API regularmente

</Steps>

### Configuración segura de pipeline

```yaml
# Usar variables protegidas para producción
deploy_production:
  stage: deploy
  script:
    - npm install -g @capgo/cli
    - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel production
  only:
    refs:
      - main
    variables:
      - $CI_COMMIT_REF_PROTECTED == "true"
```

## Monitoreo y notificaciones

### Integración con Slack

Agregue notificaciones de Slack a su pipeline:

```yaml
notify_success:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"✅ Despliegue de Capgo exitoso para '"$CI_COMMIT_REF_NAME"'"}' \
        $SLACK_WEBHOOK_URL
  when: on_success

notify_failure:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"❌ Despliegue de Capgo fallido para '"$CI_COMMIT_REF_NAME"'"}' \
        $SLACK_WEBHOOK_URL
  when: on_failure
```

### Notificaciones por correo electrónico

Configurar notificaciones por correo electrónico en la configuración de su proyecto de GitLab o Usar la API:

```yaml
notify_email:
  stage: .post
  script:
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
        --form "to=team@yourcompany.com" \
        --form "subject=Estado de despliegue de Capgo" \
        --form "body=Despliegue de $CI_COMMIT_REF_NAME completado con estado: $CI_JOB_STATUS" \
        "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/emails"
  when: always
```

## Solución de problemas

### Problemas comunes

**El pipeline falla con "Capgo CLI no encontrado":**
```yaml
# Depurar instalación de CLI
debug_cli:
  script:
    - npm install -g @capgo/cli
    - which capgo || echo "Capgo CLI no encontrado"
    - npx @capgo/cli --version
```

**Errores de autenticación:**
```yaml
# Verificar configuración de token
debug_auth:
  script:
    - |
      if [ -z "$CAPGO_TOKEN" ]; then
        echo "CAPGO_TOKEN no está configurado"
        exit 1
      fi
      echo "Longitud del token: ${#CAPGO_TOKEN}"
```

**Artefactos de construcción no encontrados:**
```yaml
# Listar salidas de construcción
debug_build:
  script:
    - ls -la dist/
    - find dist/ -type f -name "*.js" -o -name "*.html"
```

### Depurar pipeline

Agregue información de depuración para solucionar problemas:

```yaml
debug:
  stage: build
  script:
    - echo "Rama: $CI_COMMIT_REF_NAME"
    - echo "Commit: $CI_COMMIT_SHA"
    - echo "Build: $CI_PIPELINE_ID"
    - env | grep CI_ | sort
  only:
    - branches
```

## Próximos pasos

- Aprenda sobre [Canales](/docs/live-updates/channels/) para gestionar diferentes entornos de despliegue
- Explore [Almacenamiento personalizado](/docs/live-updates/custom-storage/) para escenarios de despliegue avanzados
- Configurar [Cifrado](/docs/live-updates/encryption/) para despliegues seguros
- Configurar [Comportamiento de actualización](/docs/live-updates/update-behavior/) para personalizar cómo se aplican las actualizaciones

Con la integración de GitLab CI/CD, puede automatizar sus despliegues de Capgo y garantizar actualizaciones consistentes y confiables para los usuarios de su aplicación móvil.
