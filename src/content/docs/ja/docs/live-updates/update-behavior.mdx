---
title: アップデートの動作
sidebar:
  order: 3
locale: ja
---

```import { Aside, Steps } from '@astrojs/starlight/components';

Capgoアプリのアップデートをリリースする際、ユーザーにできるだけ早くアップデートを受け取ってもらいたいと思うでしょう。しかし、ダウンロードを待たせたり、セッション中にアプリを再起動させたりしてユーザー体験を妨げたくはありません。

Capgoのアップデート動作は、アップデートを迅速に提供しつつ、ユーザーへの影響を最小限に抑えるようバランスを取るように設計されています。

## デフォルトのアップデートフロー 

デフォルトでは、Capgoは以下のようにアプリのアップデートを処理します:

<Steps>

1. アプリ起動時に、Capgoプラグインは新しいアップデートが利用可能かどうかをチェックします

2. アップデートが見つかった場合、ユーザーが現在のバージョンを使用し続けている間にバックグラウンドでダウンロードされます

3. ダウンロードが完了すると、Capgoはユーザーがアプリをバックグラウンドに移行するか完全に終了するのを待ちます

4. ユーザーが次回アプリを起動すると、更新されたバージョンが実行されます

</Steps>

このフローにより、ユーザーはアップデートの通知に邪魔されたりダウンロードを待たされたりすることなく、常に最新バージョンのアプリを実行できます。

<Aside type="tip">
Capgoはアプリがバックグラウンドから復帰する際にもアップデートをチェックするため、ユーザーはアプリを完全に終了しなくてもアップデートを受け取ることができます。
</Aside>

## なぜこのアプローチなのか?

バックグラウンドまたは終了時にアップデートを適用することには、ユーザー体験において以下のような重要なメリットがあります:

- セッション中にアップデート通知で中断されたり、ダウンロードを待たされたりすることがありません

- アップデートはセッション間でシームレスに適用されるため、アプリの起動体験は常に新鮮です

- アクティブなユーザーに影響を与える心配なく、頻繁にアップデートを提供できます

主なデメリットは、ユーザーがアプリをバックグラウンドに移行して素早く復帰した場合、これらのアクション間でアップデートが適用されるため、保存されていない状態が失われる可能性があることです。

これを緩和するために、以下を推奨します:

- 状態を頻繁に保存し、アプリ復帰時に適切に復元する

- アプリの状態を大きく変更する頻繁なアップデートを避ける

- 重要なフローについては、アップデート動作をカスタマイズすることを検討する(以下参照)

## アップデート適用のタイミングをカスタマイズする

場合によっては、アップデートをいつ適用するかをより細かく制御したい場合があります。例えば、進行中のフローが完了するまでアップデートを待機させたり、サーバーサイドの変更とアプリのアップデートを連携させたりする場合です。

Capgoは`setDelay`関数を提供しており、アップデートのインストール前に満たすべき条件を指定できます:

```typescript
import { CapacitorUpdater } from '@capgo/capacitor-updater';

await CapacitorUpdatersetMultiDelay({
  delayConditions: [
    {
      kind: 'date',
      value: '2023-06-01T00:00:00000Z',
    },
    {
      kind: 'background',
      value: '60000',
    },
  ],
});
```

この例では、2023年6月1日以降AND アプリがバックグラウンドになってから60秒以上経過するまでアップデートのインストールを遅延させます。

利用可能な遅延条件は以下の通りです:

- `date`: 特定の日時以降までアップデートの適用を待機
- `background`: アプリがバックグラウンドになってから最小の期間が経過するまで待機
- `nativeVersion`: アップデートを適用する前に、最小バージョンのネイティブバイナリがインストールされるまで待機
- `kill`: 次回のアプリ終了イベントまでアップデートの適用を待機

これらの条件を組み合わせることで、アップデートがインストールされるタイミングを正確に制御できます。

<Aside type="danger">
現在、`kill`条件は他の条件のように次のバックグラウンドイベントではなく、最初の終了イベント後にアップデートをトリガーすることに注意してください。この不整合は将来のリリースで修正される予定です。
</Aside>

## 即時アップデートを適用する

重要なアップデートや非常にシンプルな状態のアプリの場合、バックグラウンドや終了イベントを待たずに、ダウンロード完了後すぐにアップデートを適用したい場合があります。Capgoは`directUpdate`設定オプションでこれをサポートしています。

`directUpdate`はJavaScriptコードではなく、`capacitorconfigts`ファイルで設定します:

```typescript
import { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
  plugins: {
    CapacitorUpdater: {
      autoUpdate: true,
      directUpdate: true,
    },
  },
  keepUrlPathAfterReload: true,
};

export default config;
```

`directUpdate`を有効にすると、ユーザーがアプリをアクティブに使用している場合でも、ダウンロードが完了次第すぐにアップデートが適用されます。

`directUpdate`はネイティブの設定であるため、JavaScriptコードで追加の処理が必要になることに注意してください。

`directUpdate`を使用する場合は、`appReady`イベントをリッスンし、それに応じてアプリのスプラッシュスクリーンを非表示にする必要があります:

```js
import { CapacitorUpdater } from '@capgo/capacitor-updater';
import { SplashScreen } from '@capacitor/splash-screen';

CapacitorUpdateraddListener('appReady', () => {
  // スプラッシュスクリーンを非表示
  SplashScreenhide();
});

CapacitorUpdaternotifyAppReady();
```

`appReady`イベントは、アプリの初期化と保留中のアップデートの適用が完了した時点で発火します。これは、ユーザーが最新バージョンを確実に見られるようになる時点であり、アプリのUIを表示しても安全です。

`appReady`イベントの処理に加えて、`directUpdate`を使用する場合は`keepUrlPathAfterReload`設定オプションを`true`に設定することを推奨します。これにより、アップデートによるアプリのリロード時に現在のURLパスが保持され、アプリ内でのユーザーの位置が維持され、混乱を減らすことができます。

`directUpdate`使用時に`appReady`イベントを処理せず`keepUrlPathAfterReload`を設定しないと、ユーザーは古いバージョンのアプリを一時的に見たり、初期ルートに戻されたり、アップデート適用時にちらつきを見る可能性があります。

`directUpdate`は重要なバグ修正やセキュリティパッチを提供する際に便利ですが、いくつかのトレードオフがあります:

- `appReady`イベントを適切に処理しないと、アップデート適用時に一時的なちらつきやローディング状態が表示される可能性があります
- アップデートがアプリの状態やUIを変更する場合、セッション中に破壊的な変更が表示される可能性があります
- `keepUrlPathAfterReload`が設定されていない場合、アプリ内のユーザーの位置が失われ、混乱を招く可能性があります
- スムーズな移行を確保するために、状態の保存と復元を慎重に処理する必要があります

`directUpdate`を有効にする場合は、以下を推奨します:

- `appReady`イベントを処理してアプリのUIの表示を制御する
- `keepUrlPathAfterReload`を`true`に設定してアプリ内のユーザーの位置を保持する
- ユーザーの進行状況を失わないように、必要に応じてアプリの状態を保存および復元する
- 唐突な遷移、状態の損失、混乱を招く位置の変更がないことを確認するため、アプリのアップデート動作を徹底的にテストする

ほとんどの場合、デフォルトのアップデート動作が、アップデートの迅速な提供と中断の最小化の最適なバランスを提供します。しかし、特定のニーズを持つアプリについては、Capgoはアップデートがいつどのように適用されるかをカスタマイズする柔軟性を提供します。```