---
title: 高速なアップデート
sidebar:
  order: 4
locale: ja
---

CapgoのLive Updateシステムは、JS bundleすべてではなく、変更されたファイルのみを送信することで、更新をより速く効率的に配信できます。

これは特に、低速または従量制のネットワーク接続を使用しているユーザーにとって有益です。ダウンロードする必要があるデータ量が最小限に抑えられるためです。

2つ目の利点は、画像やビデオなど、めったに変更されない大きなアセットがアプリにある場合、圧縮されたJSファイルと比較して1回だけダウンロードされることです。

## 差分更新の仕組み

Capgoでの差分更新は、アプリにインストールされているCapgoプラグインによって処理されます。`--partial`フラグを使用してアプリの新しいバージョンをアップロードすると、Capgoは以下を実行します：

1 ビルド内の各ファイルが個別にアップロードされます
2 各ファイルのチェックサムが生成されます
3 すべてのファイルとそのチェックサムを一覧表示する新しいjsonマニフェストが作成されます
4 このマニフェストがCapgoデータベースにアップロードされます

アプリを実行しているデバイスが更新をチェックすると、Capgoプラグインはサーバーから新しいマニフェストを受け取ります。このマニフェストを現在持っているものと比較し、チェックサムとファイルパスに基づいて変更されたファイルを特定します。

プラグインは、JS bundleすべてではなく、変更されたファイルのみをダウンロードします。これらのダウンロードしたファイルと、すでに持っている変更されていないファイルを組み合わせて、アプリの新しいバージョンを再構築します。

<Aside title="マニフェスト">

差分更新の場合、デバイスはダウンロードしたすべてのファイルを共通のキャッシュに保存します。Capgoは決してクリーンアップしませんが、OSはいつでもクリーンアップできます。

</Aside>

## 差分更新の有効化

Capgoアプリの差分更新を有効にするには、新しいバージョンをアップロードする際に`--partial`フラグを使用するだけです：

## 差分更新の強制

すべてのアップロードを差分更新にし、誤ってフルバンドルがアップロードされることを防ぎたい場合は、`--partial-only`フラグを使用できます：

```shell
npx @capgo/cli@latest upload --partial-only
```

`--partial-only`を使用すると、Capgoは個別のファイルのアップロードとマニフェストの生成のみを行います。パーシャルをサポートしていないデバイスは更新をダウンロードできなくなります。

以下の場合に`--partial-only`の使用を検討できます：

- 常に差分更新を使用し、フルバンドルのアップロードを許可したくない場合
- CI/CDパイプラインを設定していて、すべての自動アップロードを差分更新にしたい場合
- アプリが大きく、帯域幅が制限されているため、アップロード/ダウンロードサイズを最小限に抑える必要がある場合

`--partial-only`が設定されている状態でフルバンドルのアップロードが必要な場合は、`--partial-only`なしでアップロードコマンドを実行するだけです。これにより、その1回のアップロードに限り設定が上書きされ、完全なバンドルをプッシュできます。

## トラブルシューティング

差分更新が機能していないように見える場合（小さな変更でもデバイスが常にフルJSバンドルをダウンロードする場合など）、以下を確認してください：

- 新しいバージョンをアップロードするたびに`--partial`フラグを使用していること
- `--partial-only`を使用している場合、誤って`--partial`フラグを省略していないこと
- デバイスで最新バージョンのCapgoプラグインが実行されていること
- デバイスが安定したネットワーク接続を持ち、Capgoサーバーに到達できること

Capgoウェブアプリを使用して、最後のアップロードの詳細を確認することもできます：
<Steps>
1 [webapp](https://appcapgoio)にアクセス
2 アプリをクリック
3 統計バーのバンドル数をクリック
4 最後のバンドルを選択
5 `Partial`フィールドを確認
  ![bundle type](/bundle_typewebp)
</Steps>

問題が解決しない場合は、Capgoサポートにお問い合わせください。サーバーログをチェックして、パーシャルアップロードが正しく処理され、デバイスが更新されたマニフェストを受信していることを確認できます。

以上です！`--partial`フラグは、差分更新に必要な個別のファイルアップロードとマニフェスト生成を実行するようCapgoに指示します。

差分更新として配信したい新しいバージョンをアップロードするたびに`--partial`を使用する必要があることに注意してください。フラグを省略すると、Capgoは全体のJSバンドルを1つのファイルとしてアップロードし、小さな部分のみが変更された場合でも、デバイスはバンドル全体をダウンロードします。