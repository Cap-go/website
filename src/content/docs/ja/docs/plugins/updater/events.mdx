---
title: "Events"
locale: ja
description: "Capacitor Updaterプラグインで更新のステータスと進行状況を監視するためにリッスンできるすべてのイベント"
sidebar:
  order: 9
---

import { Aside, Tabs, TabItem } from '@astrojs/starlight/components';

Capacitor Updaterプラグインは、更新プロセスを監視し、さまざまな状態に応答するためにリッスンできるいくつかのイベントを提供します。

## イベントリスナーのセットアップ

イベントをリッスンするには、`CapacitorUpdater`オブジェクトの`addListener`メソッドを使用します：

```typescript
import { CapacitorUpdater } from '@capgo/capacitor-updater';

// Add a listener
const listener = await CapacitorUpdater.addListener('eventName', (event) => {
  // Handle the event
});

// Remove the listener when no longer needed
listener.remove();

// Remove all listeners
await CapacitorUpdater.removeAllListeners();
```

## 利用可能なイベント

### `download`

バンドルのダウンロードプロセス中に発火します。ダウンロードの進行状況情報を提供します。

```typescript
CapacitorUpdater.addListener('download', (event) => {
  console.log(`Download progress: ${event.percent}%`);
  console.log('Bundle info:', event.bundle);
});
```

**イベントデータ:**
- `percent`: number - ダウンロードの進行状況（パーセンテージ、0-100）
- `bundle`: BundleInfo - ダウンロード中のバンドルに関する情報

<Aside>
このイベントは、ダウンロード中に進行状況を報告するために複数回発火します。
</Aside>

### `noNeedUpdate`

更新の確認により、更新が不要であると判断されたときに発火します。

```typescript
CapacitorUpdater.addListener('noNeedUpdate', (event) => {
  console.log('App is up to date');
  console.log('Current bundle:', event.bundle);
});
```

**イベントデータ:**
- `bundle`: BundleInfo - 現在のバンドルに関する情報

### `updateAvailable`

ダウンロード可能な新しい更新が利用可能なときに発火します。

```typescript
CapacitorUpdater.addListener('updateAvailable', (event) => {
  console.log('Update available');
  console.log('New bundle:', event.bundle);
  // You can trigger a download here if needed
});
```

**イベントデータ:**
- `bundle`: BundleInfo - 利用可能な更新バンドルに関する情報

### `downloadComplete`

バンドルのダウンロードが正常に完了したときに発火します。

```typescript
CapacitorUpdater.addListener('downloadComplete', (event) => {
  console.log('Download completed');
  console.log('Downloaded bundle:', event.bundle);
  // You might want to set this bundle as next
});
```

**イベントデータ:**
- `bundle`: BundleInfo - ダウンロードされたバンドルに関する情報

### `majorAvailable`

メジャーアップデートが利用可能だが、自動更新設定によってブロックされているときに発火します。

```typescript
CapacitorUpdater.addListener('majorAvailable', (event) => {
  console.log('Major update available:', event.version);
  // Notify user about major update
});
```

**イベントデータ:**
- `version`: string - メジャーアップデートのバージョン番号

<Aside type="tip">
メジャーアップデートは通常、ユーザーの確認またはアプリストアの更新が必要です。このイベントを使用して、ユーザーに適切に通知してください。
</Aside>

### `updateFailed`

次回のアプリ起動時に更新のインストールが失敗したときに発火します。

```typescript
CapacitorUpdater.addListener('updateFailed', (event) => {
  console.error('Update failed to install');
  console.log('Failed bundle:', event.bundle);
  // Handle rollback or retry logic
});
```

**イベントデータ:**
- `bundle`: BundleInfo - インストールに失敗したバンドルに関する情報

### `downloadFailed`

バンドルのダウンロードが失敗したときに発火します。

```typescript
CapacitorUpdater.addListener('downloadFailed', (event) => {
  console.error('Download failed for version:', event.version);
  // Handle download retry logic
});
```

**イベントデータ:**
- `version`: string - ダウンロードに失敗したバージョン

### `appReloaded`

アプリがリロードされたときに発火します。

```typescript
CapacitorUpdater.addListener('appReloaded', () => {
  console.log('App has been reloaded');
  // Perform any necessary reinitialization
});
```

**イベントデータ:** なし

### `appReady`

更新後にアプリが使用可能になったときに発火します。

```typescript
CapacitorUpdater.addListener('appReady', (event) => {
  console.log('App is ready');
  console.log('Current bundle:', event.bundle);
  console.log('Status:', event.status);
});
```

**イベントデータ:**
- `bundle`: BundleInfo - 現在のバンドルに関する情報
- `status`: string - 準備完了ステータス

<Aside type="caution">
自動ロールバックを防ぐために、設定されたタイムアウト（デフォルト10秒）内に`notifyAppReady()`を呼び出すことを忘れないでください。
</Aside>

## BundleInfoオブジェクト

多くのイベントには、次のプロパティを持つ`BundleInfo`オブジェクトが含まれています：

```typescript
interface BundleInfo {
  id: string;           // Unique bundle identifier
  version: string;      // Bundle version
  downloaded: string;   // Download timestamp
  checksum?: string;    // Bundle checksum (if available)
  status: BundleStatus; // Bundle status
}
```

Where `BundleStatus` can be:
- `'success'` - Bundle downloaded successfully
- `'error'` - Bundle download/installation failed
- `'pending'` - Bundle is pending to be set as next
- `'downloading'` - Bundle is currently downloading

## 例：完全な更新フロー

イベントを使用して完全な更新フローを処理する例を以下に示します：

<Aside type="caution">
この`UpdateManager`クラスには、自動更新フローに必要な`CapacitorUpdater.notifyAppReady()`呼び出しが含まれていません。
詳細については、[notifyAppReady呼び出しを正しく配置する](/docs/plugins/updater/auto-update#placing-notifyappready-call-correctly)ドキュメントを参照してください。
</Aside>

```typescript
import { CapacitorUpdater } from '@capgo/capacitor-updater';

export class UpdateManager {
  private listeners: any[] = [];

  async setupListeners() {
    // Listen for available updates
    this.listeners.push(
      await CapacitorUpdater.addListener('updateAvailable', async (event) => {
        console.log('Update available:', event.bundle.version);
        // Auto-download the update
        await CapacitorUpdater.download({ 
          url: event.bundle.url,
          version: event.bundle.version 
        });
      })
    );

    // Monitor download progress
    this.listeners.push(
      await CapacitorUpdater.addListener('download', (event) => {
        console.log(`Downloading: ${event.percent}%`);
        // Update UI progress bar
        this.updateProgressBar(event.percent);
      })
    );

    // Handle download completion
    this.listeners.push(
      await CapacitorUpdater.addListener('downloadComplete', async (event) => {
        console.log('Download complete:', event.bundle.version);
        // Set as next bundle
        await CapacitorUpdater.next({ id: event.bundle.id });
      })
    );

    // Handle failures
    this.listeners.push(
      await CapacitorUpdater.addListener('downloadFailed', (event) => {
        console.error('Download failed:', event.version);
        this.showError('Update download failed. Please try again later.');
      })
    );

    this.listeners.push(
      await CapacitorUpdater.addListener('updateFailed', (event) => {
        console.error('Update installation failed:', event.bundle.version);
        this.showError('Update installation failed. The app has been rolled back.');
      })
    );

    // Handle app ready
    this.listeners.push(
      await CapacitorUpdater.addListener('appReady', async (event) => {
        console.log('App ready with bundle:', event.bundle.version);
      })
    );
  }

  cleanup() {
    // Remove all listeners when no longer needed
    this.listeners.forEach(listener => listener.remove());
    this.listeners = [];
  }

  private updateProgressBar(percent: number) {
    // Update your UI progress bar
  }

  private showError(message: string) {
    // Show error to user
  }
}
```

## ベストプラクティス

1. **常に`notifyAppReady()`を呼び出す**: 自動更新を使用する場合、ロールバックを防ぐために、アプリの初期化後に常にこのメソッドを呼び出してください。

2. **失敗を適切に処理する**: ダウンロードおよび更新の失敗に対する適切なエラー処理を実装してください。

3. **ユーザーフィードバックを提供する**: ダウンロード進行状況イベントを使用して、ユーザーに更新の進行状況を表示してください。

4. **リスナーをクリーンアップする**: メモリリークを防ぐために、不要になったイベントリスナーを削除してください。

5. **更新シナリオをテストする**: 失敗、ロールバック、メジャーアップデートを含むさまざまな更新シナリオをテストしてください。
