---
title: Démarrage
description: Apprenez à installer et utiliser le plugin iBeacon pour détecter et surveiller les balises Bluetooth dans votre application Capacitor.
sidebar:
  order: 2
locale: fr
---

import { Tabs, TabItem } from '@astrojs/starlight/components';
import { Code, Steps } from '@astrojs/starlight/components';
import { PackageManagers } from 'starlight-package-managers'

<Steps>
1. **Installer le package**
   <PackageManagers pkg="@capgo/capacitor-ibeacon" pkgManagers={['npm', 'pnpm', 'yarn', 'bun']} />

2. **Synchroniser avec les projets natifs**
   <PackageManagers type="exec" pkg="cap" args="sync" pkgManagers={['npm', 'pnpm', 'yarn', 'bun']} />
</Steps>

## Configuration

### Configuration iOS

Ajoutez ce qui suit à votre `Info.plist` :

```xml
<key>NSLocationWhenInUseUsageDescription</key>
<string>This app needs location access to detect nearby beacons</string>

<key>NSLocationAlwaysAndWhenInUseUsageDescription</key>
<string>This app needs location access to monitor beacons in the background</string>

<key>NSBluetoothAlwaysUsageDescription</key>
<string>This app uses Bluetooth to detect nearby beacons</string>

<key>UIBackgroundModes</key>
<array>
  <string>location</string>
</array>
```

### Configuration Android

Ajoutez ce qui suit à votre `AndroidManifest.xml` :

```xml
<manifest>
  <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
  <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
  <uses-permission android:name="android.permission.BLUETOOTH" />
  <uses-permission android:name="android.permission.BLUETOOTH_ADMIN" />
  <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />
</manifest>
```

**Important**: Pour Android, vous devez intégrer la bibliothèque [AltBeacon](https://altbeacon.github.io/android-beacon-library/) dans votre projet pour que la détection de balises fonctionne.

Ajoutez à votre `build.gradle` de l'application :

```kotlin
dependencies {
    implementation 'org.altbeacon:android-beacon-library:2.20+'
}
```

## Utilisation

### Configuration de base

```typescript
import { CapacitorIbeacon } from '@capgo/capacitor-ibeacon';

// Define your beacon region
const beaconRegion = {
  identifier: 'MyStore',
  uuid: 'B9407F30-F5F8-466E-AFF9-25556B57FE6D',
  major: 1, // Optional
  minor: 2  // Optional
};
```

### Demander les permissions

```typescript
// Request "When In Use" permission
const requestPermission = async () => {
  const { status } = await CapacitorIbeacon.requestWhenInUseAuthorization();
  console.log('Permission status:', status);
  // status: 'not_determined' | 'restricted' | 'denied' | 'authorized_always' | 'authorized_when_in_use'
};

// Request "Always" permission (for background monitoring)
const requestAlwaysPermission = async () => {
  const { status } = await CapacitorIbeacon.requestAlwaysAuthorization();
  console.log('Always permission status:', status);
};

// Check current authorization status
const checkPermission = async () => {
  const { status } = await CapacitorIbeacon.getAuthorizationStatus();
  console.log('Current status:', status);
};
```

### Vérifier les capacités de l'appareil

```typescript
// Check if Bluetooth is enabled
const checkBluetooth = async () => {
  const { enabled } = await CapacitorIbeacon.isBluetoothEnabled();
  if (!enabled) {
    console.log('Please enable Bluetooth');
  }
};

// Check if ranging is available
const checkRanging = async () => {
  const { available } = await CapacitorIbeacon.isRangingAvailable();
  console.log('Ranging available:', available);
};
```

### Surveiller les régions de balises

La surveillance détecte lorsque vous entrez ou sortez d'une région de balises. Cela fonctionne en arrière-plan.

```typescript
// Start monitoring
const startMonitoring = async () => {
  await CapacitorIbeacon.startMonitoringForRegion({
    identifier: 'MyStore',
    uuid: 'B9407F30-F5F8-466E-AFF9-25556B57FE6D',
    major: 1,
    minor: 2
  });
  console.log('Started monitoring for beacons');
};

// Stop monitoring
const stopMonitoring = async () => {
  await CapacitorIbeacon.stopMonitoringForRegion({
    identifier: 'MyStore',
    uuid: 'B9407F30-F5F8-466E-AFF9-25556B57FE6D'
  });
};
```

### Détecter les balises

La détection fournit des mises à jour continues sur les balises à proximité et leurs distances. Cela nécessite que l'application soit au premier plan.

```typescript
// Start ranging
const startRanging = async () => {
  await CapacitorIbeacon.startRangingBeaconsInRegion({
    identifier: 'MyStore',
    uuid: 'B9407F30-F5F8-466E-AFF9-25556B57FE6D'
  });
  console.log('Started ranging beacons');
};

// Stop ranging
const stopRanging = async () => {
  await CapacitorIbeacon.stopRangingBeaconsInRegion({
    identifier: 'MyStore',
    uuid: 'B9407F30-F5F8-466E-AFF9-25556B57FE6D'
  });
};
```

### Écouter les événements

```typescript
import { PluginListenerHandle } from '@capacitor/core';

// Listen for ranging events (continuous distance updates)
const rangingListener: PluginListenerHandle = await CapacitorIbeacon.addListener(
  'didRangeBeacons',
  (data) => {
    console.log('Beacons detected:', data.beacons);
    data.beacons.forEach(beacon => {
      console.log(`UUID: ${beacon.uuid}`);
      console.log(`Major: ${beacon.major}, Minor: ${beacon.minor}`);
      console.log(`Distance: ${beacon.accuracy}m`);
      console.log(`Proximity: ${beacon.proximity}`); // immediate, near, far, unknown
      console.log(`RSSI: ${beacon.rssi}`);
    });
  }
);

// Listen for region enter events
const enterListener: PluginListenerHandle = await CapacitorIbeacon.addListener(
  'didEnterRegion',
  (data) => {
    console.log('Entered region:', data.region.identifier);
    // Show welcome notification or trigger action
  }
);

// Listen for region exit events
const exitListener: PluginListenerHandle = await CapacitorIbeacon.addListener(
  'didExitRegion',
  (data) => {
    console.log('Exited region:', data.region.identifier);
    // Trigger goodbye action
  }
);

// Listen for region state changes
const stateListener: PluginListenerHandle = await CapacitorIbeacon.addListener(
  'didDetermineStateForRegion',
  (data) => {
    console.log(`Region ${data.region.identifier}: ${data.state}`);
    // state: 'inside' | 'outside' | 'unknown'
  }
);

// Clean up listeners when done
const cleanup = () => {
  rangingListener.remove();
  enterListener.remove();
  exitListener.remove();
  stateListener.remove();
};
```

### Diffuser en tant qu'iBeacon (iOS uniquement)

Transformez votre appareil en émetteur iBeacon.

```typescript
// Start advertising
const startAdvertising = async () => {
  await CapacitorIbeacon.startAdvertising({
    uuid: 'B9407F30-F5F8-466E-AFF9-25556B57FE6D',
    major: 1,
    minor: 2,
    identifier: 'MyBeacon',
    measuredPower: -59 // Optional: calibrated power at 1 meter
  });
  console.log('Started advertising as iBeacon');
};

// Stop advertising
const stopAdvertising = async () => {
  await CapacitorIbeacon.stopAdvertising();
};
```

## Exemple complet

```typescript
import { CapacitorIbeacon } from '@capgo/capacitor-ibeacon';
import { PluginListenerHandle } from '@capacitor/core';

export class BeaconService {
  private listeners: PluginListenerHandle[] = [];

  async init() {
    // Request permissions
    const { status } = await CapacitorIbeacon.requestWhenInUseAuthorization();

    if (status !== 'authorized_when_in_use' && status !== 'authorized_always') {
      throw new Error('Location permission denied');
    }

    // Check Bluetooth
    const { enabled } = await CapacitorIbeacon.isBluetoothEnabled();
    if (!enabled) {
      throw new Error('Bluetooth is not enabled');
    }

    // Set up event listeners
    this.setupListeners();
  }

  private setupListeners() {
    this.listeners.push(
      await CapacitorIbeacon.addListener('didEnterRegion', (data) => {
        console.log('Welcome! Entered:', data.region.identifier);
        this.onEnterRegion(data.region);
      })
    );

    this.listeners.push(
      await CapacitorIbeacon.addListener('didExitRegion', (data) => {
        console.log('Goodbye! Left:', data.region.identifier);
        this.onExitRegion(data.region);
      })
    );

    this.listeners.push(
      await CapacitorIbeacon.addListener('didRangeBeacons', (data) => {
        this.onRangeBeacons(data.beacons);
      })
    );
  }

  async startMonitoring(uuid: string, identifier: string, major?: number, minor?: number) {
    await CapacitorIbeacon.startMonitoringForRegion({
      identifier,
      uuid,
      major,
      minor
    });
  }

  async startRanging(uuid: string, identifier: string) {
    await CapacitorIbeacon.startRangingBeaconsInRegion({
      identifier,
      uuid
    });
  }

  private onEnterRegion(region: any) {
    // Handle region entry (e.g., show notification, trigger content)
    console.log('Entered beacon region:', region);
  }

  private onExitRegion(region: any) {
    // Handle region exit
    console.log('Left beacon region:', region);
  }

  private onRangeBeacons(beacons: any[]) {
    // Process beacon distances
    const nearestBeacon = beacons.reduce((nearest, beacon) => {
      return beacon.accuracy < nearest.accuracy ? beacon : nearest;
    }, beacons[0]);

    if (nearestBeacon) {
      console.log('Nearest beacon:', nearestBeacon);
      this.handleProximity(nearestBeacon);
    }
  }

  private handleProximity(beacon: any) {
    switch (beacon.proximity) {
      case 'immediate': // < 0.5m
        console.log('Very close to beacon');
        break;
      case 'near': // 0.5m - 3m
        console.log('Near beacon');
        break;
      case 'far': // > 3m
        console.log('Far from beacon');
        break;
      case 'unknown':
        console.log('Distance unknown');
        break;
    }
  }

  cleanup() {
    this.listeners.forEach(listener => listener.remove());
    this.listeners = [];
  }
}
```

## Référence API

### startMonitoringForRegion(options)

Démarre la surveillance d'une région de balises. Déclenche des événements lors de l'entrée/sortie.

```typescript
interface BeaconRegion {
  identifier: string;
  uuid: string;
  major?: number;
  minor?: number;
  notifyEntryStateOnDisplay?: boolean;
}

await CapacitorIbeacon.startMonitoringForRegion(options);
```

### stopMonitoringForRegion(options)

Arrête la surveillance d'une région de balises.

```typescript
await CapacitorIbeacon.stopMonitoringForRegion(options);
```

### startRangingBeaconsInRegion(options)

Démarre la détection des balises dans une région pour des mises à jour continues de la distance.

```typescript
await CapacitorIbeacon.startRangingBeaconsInRegion(options);
```

### stopRangingBeaconsInRegion(options)

Arrête la détection des balises dans une région.

```typescript
await CapacitorIbeacon.stopRangingBeaconsInRegion(options);
```

### startAdvertising(options)

Démarre la diffusion de l'appareil en tant qu'iBeacon (iOS uniquement).

```typescript
interface BeaconAdvertisingOptions {
  uuid: string;
  major: number;
  minor: number;
  identifier: string;
  measuredPower?: number; // Calibrated power at 1 meter
}

await CapacitorIbeacon.startAdvertising(options);
```

### stopAdvertising()

Arrête la diffusion de l'appareil en tant qu'iBeacon.

```typescript
await CapacitorIbeacon.stopAdvertising();
```

### requestWhenInUseAuthorization()

Demande l'autorisation de localisation "Lors de l'utilisation".

```typescript
const result = await CapacitorIbeacon.requestWhenInUseAuthorization();
// Returns: { status: string }
```

### requestAlwaysAuthorization()

Demande l'autorisation de localisation "Toujours" (requise pour la surveillance en arrière-plan).

```typescript
const result = await CapacitorIbeacon.requestAlwaysAuthorization();
// Returns: { status: string }
```

### getAuthorizationStatus()

Obtient le statut d'autorisation de localisation actuel.

```typescript
const result = await CapacitorIbeacon.getAuthorizationStatus();
// Returns: { status: 'not_determined' | 'restricted' | 'denied' | 'authorized_always' | 'authorized_when_in_use' }
```

### isBluetoothEnabled()

Vérifie si Bluetooth est activé.

```typescript
const result = await CapacitorIbeacon.isBluetoothEnabled();
// Returns: { enabled: boolean }
```

### isRangingAvailable()

Vérifie si la détection est disponible sur l'appareil.

```typescript
const result = await CapacitorIbeacon.isRangingAvailable();
// Returns: { available: boolean }
```

### enableARMAFilter(options)

Active le filtrage ARMA pour les calculs de distance (Android uniquement).

```typescript
await CapacitorIbeacon.enableARMAFilter({ enabled: true });
```

## Événements

### didRangeBeacons

Déclenché lorsque des balises sont détectées pendant la détection.

```typescript
interface RangingEvent {
  region: BeaconRegion;
  beacons: Beacon[];
}

interface Beacon {
  uuid: string;
  major: number;
  minor: number;
  rssi: number; // Signal strength
  proximity: 'immediate' | 'near' | 'far' | 'unknown';
  accuracy: number; // Distance in meters
}
```

### didEnterRegion

Déclenché lors de l'entrée dans une région de balises surveillée.

```typescript
interface RegionEvent {
  region: BeaconRegion;
}
```

### didExitRegion

Déclenché lors de la sortie d'une région de balises surveillée.

```typescript
interface RegionEvent {
  region: BeaconRegion;
}
```

### didDetermineStateForRegion

Déclenché lorsque l'état de la région est déterminé.

```typescript
interface StateEvent {
  region: BeaconRegion;
  state: 'inside' | 'outside' | 'unknown';
}
```

## Valeurs de proximité

- **immediate**: Très proche (< 0,5 mètre)
- **near**: Relativement proche (0,5 - 3 mètres)
- **far**: Plus éloigné (> 3 mètres)
- **unknown**: La distance ne peut pas être déterminée

## Bonnes pratiques

1. **Demandez les permissions appropriées**
   - Utilisez "Lors de l'utilisation" pour les fonctionnalités au premier plan
   - Demandez "Toujours" uniquement si vous avez besoin de la surveillance en arrière-plan
   - Expliquez clairement pourquoi vous avez besoin de l'accès à la localisation

2. **Gérez l'état Bluetooth**
   ```typescript
   const { enabled } = await CapacitorIbeacon.isBluetoothEnabled();
   if (!enabled) {
     // Prompt user to enable Bluetooth
   }
   ```

3. **Optimisation de la batterie**
   - Utilisez la surveillance au lieu de la détection lorsque c'est possible (plus économe en batterie)
   - Arrêtez la détection lorsqu'elle n'est pas activement nécessaire
   - Envisagez d'utiliser des plages major/minor plus grandes pour réduire le traitement

4. **Gestion des erreurs**
   ```typescript
   try {
     await CapacitorIbeacon.startMonitoringForRegion(region);
   } catch (error) {
     console.error('Failed to start monitoring:', error);
   }
   ```

5. **Nettoyez les écouteurs**
   Supprimez toujours les écouteurs d'événements lorsque le composant se démonte pour éviter les fuites de mémoire.

## Notes de plateforme

### iOS
- Nécessite iOS 10.0+
- Utilise le framework natif CoreLocation
- Prend en charge la surveillance en arrière-plan avec la permission "Toujours"
- Peut diffuser en tant qu'iBeacon en utilisant CoreBluetooth
- La détection nécessite que l'application soit au premier plan

### Android
- Nécessite Android 6.0 (API 23)+
- Utilise la bibliothèque AltBeacon
- Nécessite des permissions de localisation même si les balises utilisent Bluetooth
- La surveillance en arrière-plan nécessite ACCESS_BACKGROUND_LOCATION (Android 10+)
- Ne peut pas diffuser en tant qu'iBeacon (limitation matérielle sur la plupart des appareils)

### Web
- Non pris en charge sur la plateforme web

## Cas d'utilisation courants

1. **Marketing de proximité**: Déclenchez des notifications ou du contenu lorsque les utilisateurs approchent de votre magasin
2. **Navigation intérieure**: Guidez les utilisateurs dans les bâtiments en utilisant des points de repère de balises
3. **Suivi de présence**: Enregistrez automatiquement l'arrivée lorsque les utilisateurs entrent dans un lieu
4. **Suivi d'actifs**: Surveillez les mouvements d'équipements ou d'inventaire
5. **Visites de musée**: Fournissez des informations contextuelles lorsque les visiteurs approchent des expositions
6. **Maison intelligente**: Déclenchez des automatisations basées sur la présence dans une pièce

## Dépannage

### Balises non détectées
- Assurez-vous que Bluetooth est activé
- Vérifiez que les permissions de localisation sont accordées
- Vérifiez que l'UUID de la balise correspond exactement (sensible à la casse)
- Confirmez que la balise est alimentée et émet
- Essayez sans filtres major/minor d'abord

### La surveillance en arrière-plan ne fonctionne pas
- Assurez-vous que la permission de localisation "Toujours" est accordée
- Ajoutez `location` à UIBackgroundModes (iOS)
- Demandez ACCESS_BACKGROUND_LOCATION (Android 10+)
- Note: iOS peut retarder les rappels en arrière-plan pour économiser la batterie

### Mesures de distance inexactes
- Le RSSI des balises varie selon l'environnement (murs, interférences)
- Utilisez plusieurs balises pour la triangulation
- Calibrez measuredPower à 1 mètre de la balise
- Activez le filtrage ARMA sur Android pour des valeurs plus fluides
