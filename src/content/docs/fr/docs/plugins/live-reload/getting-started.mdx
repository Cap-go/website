---
title: Commencer
description: Apprenez à configurer le rechargement en direct pour un développement plus rapide avec votre application Capacitor.
sidebar:
  order: 2
locale: fr
---

import { Steps } from '@astrojs/starlight/components';
import { PackageManagers } from 'starlight-package-managers'

<Steps>
1. **Installez le paquet**
   <PackageManagers pkg="@capgo/capacitor-live-reload" pkgManagers={['npm', 'pnpm', 'yarn', 'bun']} />

2. **Synchronisez avec les projets natifs**
   <PackageManagers type="exec" pkg="cap" args="sync" pkgManagers={['npm', 'pnpm', 'yarn', 'bun']} />
</Steps>

## Configuration

Configurez votre serveur de développement Vite pour fonctionner avec le rechargement en direct. Vous devez :
1. Désactiver le client HMR intégré
2. Transférer les événements de rechargement via un point de terminaison WebSocket dédié

## Utilisation

```typescript
import { LiveReload } from '@capgo/capacitor-live-reload';

// Configurer le serveur de développement
await LiveReload.configureServer({
  url: 'http://localhost:5173',
  websocketPath: '/capgo-livereload',
  autoReconnect: true,
  reconnectInterval: 2000
});

// Se connecter au serveur de développement
await LiveReload.connect();

// Écouter les événements de rechargement
LiveReload.addListener('reloadEvent', (event) => {
  console.log('Événement de rechargement:', event);
  if (event.type === 'full-reload') {
    console.log('Rechargement complet de la page déclenché');
  } else if (event.type === 'file-update') {
    console.log('Fichier mis à jour:', event.file);
  }
});

// Écouter les changements de statut de connexion
LiveReload.addListener('statusChange', (status) => {
  console.log('Statut de connexion:', status.connected);
  console.log('URL du serveur:', status.url);
});
```

## Référence API

### configureServer(options)

Stocker les paramètres du serveur de développement distant pour les connexions ultérieures.

```typescript
const status = await LiveReload.configureServer({
  url: 'http://192.168.1.100:5173',
  websocketPath: '/capgo-livereload',
  headers: {
    'Authorization': 'Bearer token'
  },
  autoReconnect: true,
  reconnectInterval: 2000
});
```

**Paramètres :**
- `url` (string) : URL de base pour le serveur de développement (par ex., `http://dev.local:5173`)
- `websocketPath` (string, optionnel) : Remplacement du chemin WebSocket (par défaut : `/ws`)
- `headers` (Record\<string, string\>, optionnel) : En-têtes supplémentaires pour la connexion WebSocket
- `autoReconnect` (boolean, optionnel) : Reconnexion automatique lors de la déconnexion (par défaut : `true`)
- `reconnectInterval` (number, optionnel) : Délai entre les tentatives de reconnexion en ms (par défaut : `2000`)

**Retourne :** `LiveReloadStatus` avec les informations de connexion

### connect()

Établir une connexion WebSocket si elle n'est pas déjà active.

```typescript
const status = await LiveReload.connect();
console.log('Connecté:', status.connected);
```

**Retourne :** Statut de connexion actuel

### disconnect()

Fermer la connexion WebSocket actuelle et désactiver la reconnexion automatique.

```typescript
await LiveReload.disconnect();
```

### getStatus()

Obtenir le statut de connexion actuel.

```typescript
const status = await LiveReload.getStatus();
console.log('Connecté:', status.connected);
console.log('URL:', status.url);
```

### reload()

Déclencher manuellement un rechargement complet de la WebView Capacitor.

```typescript
await LiveReload.reload();
```

### reloadFile(options)

Recharger un seul fichier/module (repli sur rechargement complet si non pris en charge).

```typescript
await LiveReload.reloadFile({
  path: '/src/components/MyComponent.tsx',
  hash: 'abc123'
});
```

### addListener('reloadEvent', callback)

Écouter les événements de rechargement entrants depuis le serveur.

```typescript
const handle = await LiveReload.addListener('reloadEvent', (event) => {
  switch (event.type) {
    case 'full-reload':
      console.log('Rechargement complet demandé');
      break;
    case 'file-update':
      console.log('Fichier mis à jour:', event.file?.path);
      break;
    case 'error':
      console.error('Erreur:', event.message);
      break;
  }
});

// Supprimer l'écouteur lorsque terminé
await handle.remove();
```

### addListener('statusChange', callback)

Écouter les changements de statut du socket.

```typescript
await LiveReload.addListener('statusChange', (status) => {
  console.log(status.connected ? 'Connecté' : 'Déconnecté');
});
```

### removeAllListeners()

Supprimer tous les écouteurs enregistrés.

```typescript
await LiveReload.removeAllListeners();
```

## Exemple complet

```typescript
import { LiveReload } from '@capgo/capacitor-live-reload';

export class DevServer {
  private connected = false;

  async initialize() {
    // Activer uniquement en développement
    if (process.env.NODE_ENV !== 'development') {
      return;
    }

    try {
      // Configurer le serveur
      await LiveReload.configureServer({
        url: 'http://192.168.1.100:5173',
        websocketPath: '/capgo-livereload',
        autoReconnect: true,
        reconnectInterval: 3000
      });

      // Configurer les écouteurs avant de se connecter
      await LiveReload.addListener('reloadEvent', this.handleReloadEvent.bind(this));
      await LiveReload.addListener('statusChange', this.handleStatusChange.bind(this));

      // Se connecter
      await LiveReload.connect();
    } catch (error) {
      console.error('Échec de l\'initialisation du rechargement en direct:', error);
    }
  }

  private handleReloadEvent(event: any) {
    console.log('Événement de rechargement reçu:', event.type);

    switch (event.type) {
      case 'full-reload':
        this.performFullReload();
        break;
      case 'file-update':
        this.handleFileUpdate(event.file);
        break;
      case 'error':
        console.error('Erreur du serveur:', event.message);
        break;
      case 'connected':
        console.log('Serveur connecté');
        break;
      case 'disconnected':
        console.log('Serveur déconnecté');
        break;
    }
  }

  private handleStatusChange(status: any) {
    this.connected = status.connected;
    console.log(`Rechargement en direct ${status.connected ? 'connecté' : 'déconnecté'}`);
  }

  private performFullReload() {
    console.log('Exécution du rechargement complet de la page...');
    window.location.reload();
  }

  private handleFileUpdate(file: any) {
    console.log('Fichier mis à jour:', file?.path);
    // HMR gérera cela automatiquement dans la plupart des cas
  }

  async disconnect() {
    await LiveReload.disconnect();
    await LiveReload.removeAllListeners();
    this.connected = false;
  }

  isConnected(): boolean {
    return this.connected;
  }
}
```

## Exemple de configuration Vite

Configurez votre serveur Vite pour fonctionner avec le plugin de rechargement en direct :

```typescript
// vite.config.ts
import { defineConfig } from 'vite';

export default defineConfig({
  server: {
    host: '0.0.0.0', // Autoriser les connexions depuis le réseau
    port: 5173,
    hmr: {
      // Chemin WebSocket personnalisé pour le rechargement en direct
      path: '/capgo-livereload',
    }
  }
});
```

## Bonnes pratiques

1. **Utiliser uniquement en développement**
   ```typescript
   if (import.meta.env.DEV) {
     await LiveReload.configureServer({
       url: 'http://localhost:5173',
       websocketPath: '/capgo-livereload'
     });
     await LiveReload.connect();
   }
   ```

2. **Utiliser votre IP locale pour les tests mobiles**
   ```typescript
   const devServerUrl = process.env.VITE_DEV_SERVER_URL || 'http://192.168.1.100:5173';
   await LiveReload.configureServer({ url: devServerUrl });
   ```

3. **Gérer les erreurs de connexion avec élégance**
   ```typescript
   try {
     await LiveReload.connect();
   } catch (error) {
     console.warn('Impossible de se connecter au serveur de développement, utilisation du build de production');
   }
   ```

4. **Nettoyer à la sortie de l'application**
   ```typescript
   window.addEventListener('beforeunload', async () => {
     await LiveReload.disconnect();
   });
   ```

5. **Afficher le statut de connexion dans l'interface**
   ```typescript
   LiveReload.addListener('statusChange', (status) => {
     // Afficher l'indicateur dans les builds de développement
     updateDevIndicator(status.connected);
   });
   ```

## Notes sur les plateformes

### iOS
- Fonctionne avec iOS 11.0+
- Assurez-vous que le serveur de développement est accessible depuis le réseau de votre appareil
- Peut nécessiter de configurer le pare-feu pour autoriser les connexions

### Android
- Fonctionne avec Android 5.0 (API 21)+
- Utilisez `adb reverse` pour les connexions localhost :
  ```bash
  adb reverse tcp:5173 tcp:5173
  ```

### Web
- Support complet pour la plateforme web
- Connexion WebSocket directe au serveur de développement Vite

## Dépannage

**La connexion échoue :**
- Vérifiez que le serveur de développement est en cours d'exécution
- Vérifiez que l'appareil et l'ordinateur sont sur le même réseau
- Assurez-vous que le pare-feu autorise les connexions sur le port
- Utilisez l'adresse IP au lieu de localhost pour les appareils mobiles

**Rechargement lent :**
- Vérifiez la vitesse du réseau
- Réduisez l'intervalle de reconnexion
- Optimisez la configuration de build Vite

**Erreurs WebSocket :**
- Vérifiez que websocketPath correspond à la configuration Vite
- Vérifiez les conflits de port
- Assurez-vous que les en-têtes sont corrects si vous utilisez l'authentification
