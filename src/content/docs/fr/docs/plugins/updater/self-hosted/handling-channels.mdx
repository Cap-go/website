---
title: "Point de terminaison API de canal"
locale: fr
description: "Comment créer des points de terminaison de gestion de canaux pour Capgo auto-hébergé afin de gérer les attributions appareil-canal et les requêtes de canal"
sidebar:
  order: 8
---

Les canaux sont un mécanisme central pour gérer les mises à jour d'applications dans Capgo. En mode auto-hébergé, vous devez implémenter des points de terminaison de canaux pour gérer les attributions d'appareils, les requêtes de canaux et les opérations de gestion de canaux.

## Comprendre les canaux

Les canaux vous permettent de :
- **Contrôler la distribution des mises à jour** : Attribuer différentes versions d'application à différents groupes d'utilisateurs
- **Tests A/B** : Tester de nouvelles fonctionnalités avec des segments d'utilisateurs spécifiques
- **Déploiements progressifs** : Déployer progressivement les mises à jour pour minimiser les risques
- **Séparation des environnements** : Séparer les mises à jour de développement, de staging et de production

## Configuration

Configurez l'URL du point de terminaison de canal dans votre `capacitor.config.json` :

```json
{
  "plugins": {
    "CapacitorUpdater": {
      "channelUrl": "https://monserveur.com/api/channel_self"
    }
  }
}
```

## Opérations de canal

Le plugin effectue différentes opérations de canal que votre point de terminaison doit gérer :

### 1. Obtenir le canal (requête GET)

Lorsque le plugin appelle `getChannel()`, il envoie une requête GET pour récupérer l'attribution de canal actuelle de l'appareil.

#### Format de requête
```typescript
// GET /api/channel_self
// En-têtes :
{
  "Content-Type": "application/json"
}

// Paramètres de requête ou corps :
interface GetChannelRequest {
  device_id: string
  app_id: string
  platform: "ios" | "android"
  plugin_version: string
  version_build: string
  version_code: string
  version_name: string
}
```

#### Format de réponse
```json
{
  "status": "ok",
  "channel": "production",
  "allowSet": true,
  "message": "",
  "error": ""
}
```

### 2. Définir le canal (requête POST)

Lorsque le plugin appelle `setChannel()`, il envoie une requête POST pour attribuer l'appareil à un canal spécifique.

#### Format de requête
```typescript
// POST /api/channel_self
interface SetChannelRequest {
  device_id: string
  app_id: string
  channel: string
  platform: "ios" | "android"
  plugin_version: string
  version_build: string
  version_code: string
  version_name: string
}
```

#### Format de réponse
```json
{
  "status": "ok",
  "message": "Appareil attribué au canal avec succès",
  "error": ""
}
```

### 3. Annuler le canal (requête DELETE)

Lorsque le plugin appelle `unsetChannel()`, il envoie une requête DELETE pour supprimer l'attribution de canal de l'appareil.

#### Format de requête
```typescript
// DELETE /api/channel_self
interface UnsetChannelRequest {
  device_id: string
  app_id: string
  platform: "ios" | "android"
  plugin_version: string
  version_build: string
  version_code: string
  version_name: string
}
```

## Exemple d'implémentation

Voici un exemple JavaScript de la façon d'implémenter le point de terminaison de canal :

```typescript
interface ChannelRequest {
  device_id: string
  app_id: string
  channel?: string
  platform: "ios" | "android"
  plugin_version: string
  version_build: string
  version_code: string
  version_name: string
}

interface ChannelResponse {
  status: "ok" | "error"
  channel?: string
  allowSet?: boolean
  message?: string
  error?: string
}

export const handler = async (event) => {
  const method = event.httpMethod || event.method
  const body = JSON.parse(event.body || '{}') as ChannelRequest

  const { device_id, app_id, channel, platform } = body

  try {
    switch (method) {
      case 'GET':
        return await getDeviceChannel(device_id, app_id)

      case 'POST':
        return await setDeviceChannel(device_id, app_id, channel!, platform)

      case 'DELETE':
        return await unsetDeviceChannel(device_id, app_id)

      default:
        return {
          status: "error",
          error: "Méthode non autorisée"
        }
    }
  } catch (error) {
    return {
      status: "error",
      error: error.message
    }
  }
}

async function getDeviceChannel(deviceId: string, appId: string): Promise<ChannelResponse> {
  // Interrogez votre base de données pour l'attribution de canal de l'appareil
  const assignment = await database.getDeviceChannel(deviceId, appId)

  if (assignment) {
    return {
      status: "ok",
      channel: assignment.channel,
      allowSet: assignment.allowSelfAssign
    }
  }

  // Retourner le canal par défaut si aucune attribution n'est trouvée
  return {
    status: "ok",
    channel: "production", // Votre canal par défaut
    allowSet: true
  }
}

async function setDeviceChannel(
  deviceId: string,
  appId: string,
  channel: string,
  platform: string
): Promise<ChannelResponse> {
  // Valider que le canal existe et autorise l'auto-attribution
  const channelConfig = await database.getChannelConfig(channel, appId)

  if (!channelConfig) {
    return {
      status: "error",
      error: "Canal introuvable"
    }
  }

  if (!channelConfig.allowDeviceSelfSet) {
    return {
      status: "error",
      error: "Le canal n'autorise pas l'auto-attribution"
    }
  }

  // Vérifier les restrictions de plateforme
  if (platform === "ios" && !channelConfig.ios) {
    return {
      status: "error",
      error: "Canal non disponible pour iOS"
    }
  }

  if (platform === "android" && !channelConfig.android) {
    return {
      status: "error",
      error: "Canal non disponible pour Android"
    }
  }

  // Sauvegarder l'attribution
  await database.setDeviceChannel(deviceId, appId, channel)

  return {
    status: "ok",
    message: "Appareil attribué au canal avec succès"
  }
}

async function unsetDeviceChannel(deviceId: string, appId: string): Promise<ChannelResponse> {
  // Supprimer l'attribution de canal de l'appareil
  await database.removeDeviceChannel(deviceId, appId)

  return {
    status: "ok",
    message: "Attribution de canal de l'appareil supprimée"
  }
}
```

## Configuration des canaux

Votre système de canaux devrait prendre en charge ces options de configuration :

```typescript
interface ChannelConfig {
  name: string
  appId: string

  // Ciblage de plateforme
  ios: boolean
  android: boolean

  // Restrictions d'appareil
  allowDeviceSelfSet: boolean  // Autoriser les appels setChannel()
  allowEmulator: boolean
  allowDev: boolean           // Autoriser les builds de développement

  // Politiques de mise à jour
  disableAutoUpdate: "major" | "minor" | "version_number" | "none"
  disableAutoUpdateUnderNative: boolean

  // Attribution
  isDefault: boolean          // Canal par défaut pour les nouveaux appareils
}
```

## Exemple de schéma de base de données

Vous devrez stocker les configurations de canaux et les attributions d'appareils :

```sql
-- Table des canaux
CREATE TABLE channels (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  app_id VARCHAR(255) NOT NULL,
  ios BOOLEAN DEFAULT true,
  android BOOLEAN DEFAULT true,
  allow_device_self_set BOOLEAN DEFAULT false,
  allow_emulator BOOLEAN DEFAULT true,
  allow_dev BOOLEAN DEFAULT true,
  disable_auto_update VARCHAR(50) DEFAULT 'none',
  disable_auto_update_under_native BOOLEAN DEFAULT false,
  is_default BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(name, app_id)
);

-- Table des attributions de canal d'appareil
CREATE TABLE device_channels (
  id SERIAL PRIMARY KEY,
  device_id VARCHAR(255) NOT NULL,
  app_id VARCHAR(255) NOT NULL,
  channel_name VARCHAR(255) NOT NULL,
  assigned_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(device_id, app_id)
);
```

## Gestion des erreurs

Gérez les scénarios d'erreur courants :

```typescript
// Canal introuvable
{
  "status": "error",
  "error": "Canal 'beta' introuvable"
}

// Auto-attribution non autorisée
{
  "status": "error",
  "error": "Le canal n'autorise pas l'auto-attribution de l'appareil"
}

// Plateforme non prise en charge
{
  "status": "error",
  "error": "Canal non disponible pour cette plateforme"
}

// Requête invalide
{
  "status": "error",
  "error": "Champ requis manquant : device_id"
}
```

## Bonnes pratiques

1. **Sécurité** : Validez toutes les attributions de canaux par rapport à vos règles métier
2. **Journalisation** : Enregistrez toutes les opérations de canal pour l'audit et le débogage
3. **Performance** : Mettez en cache les configurations de canaux pour réduire les requêtes de base de données
4. **Validation** : Vérifiez l'authenticité de device_id et app_id
5. **Limitation de débit** : Implémentez une limitation de débit pour éviter les abus

## Intégration avec les mises à jour

Les attributions de canaux fonctionnent avec votre [Point de terminaison API de mise à jour](/docs/plugin/self-hosted/handling-updates/). Lorsqu'un appareil demande une mise à jour, vérifiez son attribution de canal pour déterminer quelle version servir :

```typescript
async function getUpdateForDevice(deviceId: string, appId: string) {
  // Obtenir l'attribution de canal de l'appareil
  const channelAssignment = await getDeviceChannel(deviceId, appId)
  const channel = channelAssignment.channel || 'production'

  // Obtenir la version attribuée à ce canal
  const channelVersion = await getChannelVersion(channel, appId)

  return {
    version: channelVersion.version,
    url: channelVersion.url,
    checksum: channelVersion.checksum
  }
}
```

Cela crée un système de gestion de canaux auto-hébergé complet qui vous donne un contrôle total sur la façon dont les mises à jour sont distribuées à vos utilisateurs.
