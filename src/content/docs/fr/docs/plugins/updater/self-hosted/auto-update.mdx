---
title: "Mise à jour automatique"
locale: fr
description: "Comment utiliser le point de terminaison de mise à jour de Capgo avec le plugin de mise à jour automatique en mode auto-hébergé, à quoi ils servent et à quoi s'attendre"
sidebar:
  order: 4
---

import { LinkCard, CardGrid } from '@astrojs/starlight/components';

Cette documentation expliquera comment exécuter votre serveur de mise à jour automatique.

## Servir votre bundle
Assurez-vous que votre bundle est servi via HTTPS, et que le serveur a les bons en-têtes CORS pour permettre à l'application de télécharger la mise à jour.
par exemple ```https://monserveur.com/app/updates/updates.json```


Si vous n'êtes pas familier avec le service d'un bundle, nous vous recommandons d'essayer Capgo Cloud ou de voir un exemple ici :
<LinkCard
	title="Servir un Bundle"
	href="/docs/self-hosted/auto-update/update-endpoint"
/>

## Configuration
Ajoutez un ``updateUrl`` à votre ``capacitor.config.json``.

```json
{
	"plugins": {
		"CapacitorUpdater": {
			"updateUrl": "https://monserveur.com/app/updates/updates.json",
		}
	}
}
```
:::caution
Lorsque vous poussez une mise à jour auto-hébergée, gardez à l'esprit que vous ne pouvez pas utiliser un point de terminaison "HTTP" car cela va à l'encontre des politiques de sécurité des applications Android, à des fins de test vous pouvez [l'autoriser](https://stackoverflow.com/questions/45940861/android-8-cleartext-http-traffic-not-permitted).
:::

## API de mise à jour

Le plugin effectuera un appel POST à votre API à chaque ouverture de l'application, avec ce corps :

```typescript
interface AppInfos {
    "platform": "ios" | "android",
    "device_id": "UUID_de_l'appareil_unique_par_installation",
    "app_id": "APPID_DU_CAPACITOR_CONFIG",
    "custom_id": "votre_custom_id_defini_au_runtime",
    "plugin_version": "VERSION_DU_PLUGIN",
    "version_build": "NUMERO_VERSION_DU_CODE_NATIF",
    "version_code": "CODE_VERSION_DU_CODE_NATIF",
    "version_name": "DERNIERE_VERSION_TELECHARGEE" | "builtin"
    "version_os": "VERSION_DU_SYSTEME_OS",
    "is_emulator": boolean,
    "is_prod": boolean,
}
```

L'API du serveur doit répondre, en JSON, au plugin capacitor-updater. Avec ces données si une mise à jour est nécessaire :

```json
{
"version": "1.2.3",
"url": "https://monserveur.com/app/updates/ma-nouvelle-app-2.0.0.zip",
"checksum": "checksum_sha256_du_bundle"
}
```

En mode de mise à jour automatique, le serveur doit comparer les versions et renvoyer la bonne, si la clé URL est présente, le plugin démarre le processus de téléchargement.

Si vous ajoutez les clés "message" et "error", la version ne sera pas définie, et le message sera affiché dans les logs à la place.

La clé `version` doit être au format [`semver`](https://semver.org/).

Le zip doit avoir `index.html` comme fichier à la racine, ou seulement un dossier à la racine avec `index.html` à l'intérieur.


Vous pouvez utiliser la commande du CLI pour zipper votre bundle :

```bash title="Créer un bundle avec vos fichiers à servir depuis votre serveur"
npx @capgo/cli bundle zip --path [/chemin/vers/mon/bundle]
```

## Génération du checksum du bundle

**Important :** Vous devez utiliser le CLI Capgo pour créer votre fichier zip de bundle. Le plugin Capgo nécessite un format et une structure zip spécifiques qui ne sont garantis que lors de l'utilisation de l'outil CLI officiel. Les utilitaires zip standard peuvent créer des archives incompatibles.

Pour générer le checksum de votre bundle, utilisez la commande zip du CLI Capgo avec le flag `--json` :

```bash title="Créer un bundle avec les informations de checksum"
npx @capgo/cli bundle zip [appId] --json
```

Cette commande va :
- Créer un fichier zip correctement formaté compatible avec le plugin Capgo
- Générer le checksum SHA256 pour la vérification de l'intégrité
- Afficher les informations du bundle au format JSON

Exemple de sortie :
```json
{
  "version": "1.2.3",
  "checksum": "a1b2c3d4e5f6789...",
  "size": 1234567
}
```

Utilisez la valeur `checksum` de cette sortie dans votre réponse API pour garantir que le plugin peut vérifier l'intégrité du bundle avant l'installation.
