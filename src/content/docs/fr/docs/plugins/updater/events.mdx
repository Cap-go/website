---
title: "Events"
locale: fr
description: "Tous les événements que vous pouvez écouter dans le plugin Capacitor Updater pour surveiller l'état et la progression des mises à jour"
sidebar:
  order: 9
---

import { Aside, Tabs, TabItem } from '@astrojs/starlight/components';

Le plugin Capacitor Updater fournit plusieurs événements que vous pouvez écouter pour surveiller le processus de mise à jour et réagir à différents états.

## Configuration de l'écouteur d'événements

Pour écouter les événements, utilisez la méthode `addListener` sur l'objet `CapacitorUpdater` :

```typescript
import { CapacitorUpdater } from '@capgo/capacitor-updater';

// Ajouter un écouteur
const listener = await CapacitorUpdater.addListener('eventName', (event) => {
  // Gérer l'événement
});

// Supprimer l'écouteur quand il n'est plus nécessaire
listener.remove();

// Supprimer tous les écouteurs
await CapacitorUpdater.removeAllListeners();
```

## Événements disponibles

### `download`

Déclenché pendant le processus de téléchargement du bundle. Fournit des informations sur la progression du téléchargement.

```typescript
CapacitorUpdater.addListener('download', (event) => {
  console.log(`Progression du téléchargement : ${event.percent}%`);
  console.log('Infos du bundle :', event.bundle);
});
```

**Données de l'événement :**
- `percent`: number - Pourcentage de progression du téléchargement (0-100)
- `bundle`: BundleInfo - Informations sur le bundle en cours de téléchargement

<Aside>
Cet événement se déclenche plusieurs fois pendant le téléchargement pour rapporter la progression.
</Aside>

### `noNeedUpdate`

Déclenché lorsqu'une vérification de mise à jour détermine qu'aucune mise à jour n'est nécessaire.

```typescript
CapacitorUpdater.addListener('noNeedUpdate', (event) => {
  console.log('L\'application est à jour');
  console.log('Bundle actuel :', event.bundle);
});
```

**Données de l'événement :**
- `bundle`: BundleInfo - Informations sur le bundle actuel

### `updateAvailable`

Déclenché lorsqu'une nouvelle mise à jour est disponible au téléchargement.

```typescript
CapacitorUpdater.addListener('updateAvailable', (event) => {
  console.log('Mise à jour disponible');
  console.log('Nouveau bundle :', event.bundle);
  // Vous pouvez déclencher un téléchargement ici si nécessaire
});
```

**Données de l'événement :**
- `bundle`: BundleInfo - Informations sur le bundle de mise à jour disponible

### `downloadComplete`

Déclenché lorsqu'un téléchargement de bundle est terminé avec succès.

```typescript
CapacitorUpdater.addListener('downloadComplete', (event) => {
  console.log('Téléchargement terminé');
  console.log('Bundle téléchargé :', event.bundle);
  // Vous pourriez vouloir définir ce bundle comme le suivant
});
```

**Données de l'événement :**
- `bundle`: BundleInfo - Informations sur le bundle téléchargé

### `majorAvailable`

Déclenché lorsqu'une mise à jour majeure est disponible mais bloquée par les paramètres de mise à jour automatique.

```typescript
CapacitorUpdater.addListener('majorAvailable', (event) => {
  console.log('Mise à jour majeure disponible :', event.version);
  // Notifier l'utilisateur de la mise à jour majeure
});
```

**Données de l'événement :**
- `version`: string - Le numéro de version de la mise à jour majeure

<Aside type="tip">
Les mises à jour majeures nécessitent généralement une confirmation de l'utilisateur ou des mises à jour de l'app store. Utilisez cet événement pour notifier les utilisateurs de manière appropriée.
</Aside>

### `updateFailed`

Déclenché lorsqu'une mise à jour n'a pas réussi à s'installer au prochain démarrage de l'application.

```typescript
CapacitorUpdater.addListener('updateFailed', (event) => {
  console.error('Échec de l\'installation de la mise à jour');
  console.log('Bundle échoué :', event.bundle);
  // Gérer la logique de rollback ou de nouvelle tentative
});
```

**Données de l'événement :**
- `bundle`: BundleInfo - Informations sur le bundle qui n'a pas réussi à s'installer

### `downloadFailed`

Déclenché lorsqu'un téléchargement de bundle a échoué.

```typescript
CapacitorUpdater.addListener('downloadFailed', (event) => {
  console.error('Échec du téléchargement pour la version :', event.version);
  // Gérer la logique de nouvelle tentative de téléchargement
});
```

**Données de l'événement :**
- `version`: string - La version dont le téléchargement a échoué

### `appReloaded`

Déclenché lorsque l'application a été rechargée.

```typescript
CapacitorUpdater.addListener('appReloaded', () => {
  console.log('L\'application a été rechargée');
  // Effectuer toute réinitialisation nécessaire
});
```

**Données de l'événement :** Aucune

### `appReady`

Déclenché lorsque l'application est prête à être utilisée après une mise à jour.

```typescript
CapacitorUpdater.addListener('appReady', (event) => {
  console.log('L\'application est prête');
  console.log('Bundle actuel :', event.bundle);
  console.log('Statut :', event.status);
});
```

**Données de l'événement :**
- `bundle`: BundleInfo - Informations sur le bundle actuel
- `status`: string - Le statut de préparation

<Aside type="caution">
N'oubliez pas d'appeler `notifyAppReady()` dans le délai configuré (par défaut 10 secondes) pour éviter un rollback automatique.
</Aside>

## Objet BundleInfo

De nombreux événements incluent un objet `BundleInfo` avec les propriétés suivantes :

```typescript
interface BundleInfo {
  id: string;           // Identifiant unique du bundle
  version: string;      // Version du bundle
  downloaded: string;   // Horodatage du téléchargement
  checksum?: string;    // Somme de contrôle du bundle (si disponible)
  status: BundleStatus; // Statut du bundle
}
```

Où `BundleStatus` peut être :
- `'success'` - Bundle téléchargé avec succès
- `'error'` - Échec du téléchargement/installation du bundle
- `'pending'` - Bundle en attente d'être défini comme suivant
- `'downloading'` - Bundle en cours de téléchargement

## Exemple : Flux de mise à jour complet

Voici un exemple de gestion du flux de mise à jour complet avec les événements :

<Aside type="caution">
Cette classe `UpdateManager` n'inclut pas l'appel `CapacitorUpdater.notifyAppReady()` requis pour le flux de mise à jour automatique.
Veuillez consulter la documentation [placer correctement l'appel notifyAppReady](/docs/plugins/updater/auto-update#placing-notifyappready-call-correctly) pour plus d'informations.
</Aside>

```typescript
import { CapacitorUpdater } from '@capgo/capacitor-updater';

export class UpdateManager {
  private listeners: any[] = [];

  async setupListeners() {
    // Écouter les mises à jour disponibles
    this.listeners.push(
      await CapacitorUpdater.addListener('updateAvailable', async (event) => {
        console.log('Mise à jour disponible :', event.bundle.version);
        // Télécharger automatiquement la mise à jour
        await CapacitorUpdater.download({
          url: event.bundle.url,
          version: event.bundle.version
        });
      })
    );

    // Surveiller la progression du téléchargement
    this.listeners.push(
      await CapacitorUpdater.addListener('download', (event) => {
        console.log(`Téléchargement : ${event.percent}%`);
        // Mettre à jour la barre de progression de l'interface utilisateur
        this.updateProgressBar(event.percent);
      })
    );

    // Gérer la fin du téléchargement
    this.listeners.push(
      await CapacitorUpdater.addListener('downloadComplete', async (event) => {
        console.log('Téléchargement terminé :', event.bundle.version);
        // Définir comme bundle suivant
        await CapacitorUpdater.next({ id: event.bundle.id });
      })
    );

    // Gérer les échecs
    this.listeners.push(
      await CapacitorUpdater.addListener('downloadFailed', (event) => {
        console.error('Échec du téléchargement :', event.version);
        this.showError('Échec du téléchargement de la mise à jour. Veuillez réessayer plus tard.');
      })
    );

    this.listeners.push(
      await CapacitorUpdater.addListener('updateFailed', (event) => {
        console.error('Échec de l\'installation de la mise à jour :', event.bundle.version);
        this.showError('Échec de l\'installation de la mise à jour. L\'application a été restaurée.');
      })
    );

    // Gérer l'application prête
    this.listeners.push(
      await CapacitorUpdater.addListener('appReady', async (event) => {
        console.log('Application prête avec le bundle :', event.bundle.version);
      })
    );
  }

  cleanup() {
    // Supprimer tous les écouteurs quand ils ne sont plus nécessaires
    this.listeners.forEach(listener => listener.remove());
    this.listeners = [];
  }

  private updateProgressBar(percent: number) {
    // Mettre à jour votre barre de progression de l'interface utilisateur
  }

  private showError(message: string) {
    // Afficher l'erreur à l'utilisateur
  }
}
```

## Bonnes pratiques

1. **Appelez toujours `notifyAppReady()`** : Lors de l'utilisation de la mise à jour automatique, appelez toujours cette méthode après l'initialisation de votre application pour éviter un rollback.

2. **Gérez les échecs avec élégance** : Implémentez une gestion d'erreur appropriée pour les échecs de téléchargement et de mise à jour.

3. **Fournissez un retour à l'utilisateur** : Utilisez l'événement de progression du téléchargement pour montrer la progression de la mise à jour aux utilisateurs.

4. **Nettoyez les écouteurs** : Supprimez les écouteurs d'événements lorsqu'ils ne sont plus nécessaires pour éviter les fuites de mémoire.

5. **Testez les scénarios de mise à jour** : Testez divers scénarios de mise à jour incluant les échecs, les rollbacks et les mises à jour majeures.
