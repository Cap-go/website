---
title: Connexion Apple sur Android
locale: fr
description: Ce guide fournit une procédure complète pour configurer la connexion Apple avec Capacitor pour les appareils iOS, détaillant chaque étape pour garantir un processus d'intégration fluide.
sidebar:
    order: 3
---
import AndroidAppleLoginGraph from '@/components/AndroidAppleLoginGraph.astro'
import { Steps } from '@astrojs/starlight/components';

La connexion Apple sur Android est compliquée. Apple n'a pas de support officiel pour `Sign in with Apple` sur Android, donc la solution est légèrement hacky.

Android utilise actuellement des onglets Chrome pour afficher un site web OAuth2. Cette approche présente les défis suivants :

- Configuration difficile
- Un backend est requis

## Comprendre le flux sur Android

Permettez-moi d'utiliser un diagramme pour expliquer le flux sur Android :

<AndroidAppleLoginGraph />

Maintenant que vous êtes conscient des défis et du flux, commençons la configuration.

## Création de l'ID de service

<Steps>
1. Connectez-vous au [portail développeur Apple](https://developer.apple.com).

2. Cliquez sur `Identifiers`.

    <img src="/social-login-assets/apple_dev_portal_iden.png" alt="Section Identifiers du portail développeur Apple" />

    Vous devriez voir un écran qui ressemble à ceci :

    <img src="/social-login-assets/apple_dev_portal_iden_2.png" alt="Écran des identifiers du portail développeur Apple" />

    1. Assurez-vous que ce champ indique <code>App IDs</code>
    2. Assurez-vous de pouvoir trouver votre App ID.
        :::note
        Si vous n'avez pas configuré la connexion Apple pour iOS, vous devrez en créer un. Pour moi, j'en ai déjà un de créé. L'App ID que j'utiliserai est `me.wcaleniewolny.test.ionic.vue`. Si vous n'en avez pas, veuillez en créer un en utilisant [l'étape de création d'application](#creating-the-app).
        :::
3. Assurez-vous que la capacité `Sign in with Apple` est activée pour votre application
    1. Cliquez sur votre application
        <img src="/social-login-assets/apple_dev_click_on_app.png" alt="Sélection de votre application dans la liste" />
    2. Assurez-vous que la capacité `Sign in with Apple` est activée
        <img src="/social-login-assets/apple_dev_sign_in_with_apple_enabled.png" alt="Case à cocher de la capacité Sign in with Apple activée" />
    3. Si elle n'est pas activée, activez-la.
4. Retournez à `All Identifiers`
    <img src="/social-login-assets/apple_dev_go_back_iden.png" alt="Bouton de navigation All Identifiers" />
5. Cliquez sur `App Ids` et allez à `Services IDs`
   <img src="/social-login-assets/apple_dev_go_to_services_id.png" alt="Navigation vers la section Services IDs" />
6. Créez un nouvel identifiant
    1. Cliquez sur le bouton plus
        <img src="/social-login-assets/apple_dev_iden_add.png" alt="Bouton d'ajout d'un nouvel ID de service" />

    2. Sélectionnez `Servcice IDs` et cliquez sur `Continue`
        <img src="/social-login-assets/apple_dev_service_and_cont.png" alt="Sélection de l'option Services IDs" />

    3. Entrez une description et des identifiants et cliquez sur `Continuie`.

        <img src="/social-login-assets/apple_dev_reg_service_2.png" alt="Saisie des détails de l'ID de service" />

        :::note
        Ces `identifiers` deviendront le `clientId` que vous passerez dans la fonction `initialize` ET `ANDROID_SERVICE_ID` pour le backend.

        **Veuillez le sauvegarder !!!**
        :::

        :::note
        L'ID de service n'a pas besoin de correspondre à l'App ID, mais je recommande de définir l'ID de service sur `YOUR_APP_ID.service`. Pour rappel, j'utilise `me.wcaleniewolny.test.ionic.vue` pour mon App ID mais j'utilise `ee.forgr.io.ionic.service2` comme ID de service.
        :::
    4. Veuillez vérifier les détails et cliquer sur `Register`
        <img src="/social-login-assets/apple_dev_service_ref_fin.png" alt="Confirmation de l'enregistrement de l'ID de service" />

    5. Cliquez sur le service nouvellement créé
        <img src="/social-login-assets/apple_dev_open_serv.png" alt="Sélection de l'ID de service nouvellement créé" />

    6. Activez l'option `Sign in with Apple`
        <img src="/social-login-assets/apple_dev_serv_enable_sign_with_apple.png" alt="Activation de Sign in with Apple pour l'ID de service" />

    7. Configurez le `Sign In with Apple`
        <img src="/social-login-assets/apple_dev_conf_serv_sign_with_apple.png" alt="Bouton de configuration pour Sign in with Apple" />

    8. Assurez-vous que le `Primary App ID` est défini sur l'App ID configuré à l'étape précédente
        <img src="/social-login-assets/apple_dev_service_prim_id.png" alt="Menu déroulant de définition du Primary App ID" />

    9. Ajoutez le domaine sur lequel vous allez héberger votre backend.

        <img src="/social-login-assets/apple_dev_serv_create_next.png" alt="Champs de définition du domaine et de l'URL de retour" />

        :::note
        Ce backend **doit** fonctionner sur HTTPS. Quant aux `Return URLs`, vous voudrez peut-être revenir à cela après avoir lu la section suivante de ce tutoriel et après avoir configuré le backend. Pour les besoins de ce tutoriel, j'utiliserai `https://xyz.wcaleniewolny.me/login/callback` pour l'URL de retour et `xyz.wcaleniewolny.me` pour le domaine. Appuyez sur next.
        :::

    10. Confirmez les données et cliquez sur `Done`
        <img src="/social-login-assets/apple_dev_serv_conf_done.png" alt="Confirmation de la configuration du domaine et de l'URL de retour" />

    11. Cliquez sur `Continue`
        <img src="/social-login-assets/apple_dev_cont_serv_creat.png" alt="Bouton Continue pour la configuration du service" />

    12. Cliquez sur `Save`
        <img src="/social-login-assets/apple_dev_cont_serv_creat_save.png" alt="Bouton Save pour la configuration du service" />
</Steps>

## Création de la clé

<Steps>
1. Retournez à `All Identifiers`
    <img src="/social-login-assets/apple_dev_go_back_iden.png" alt="Bouton de navigation All Identifiers" />
2. Cliquez sur `Keys`
    <img src="/social-login-assets/apple_dev_key_selc.png" alt="Section Keys dans le portail développeur Apple" />
3. Cliquez sur l'icône plus
    <img src="/social-login-assets/apple_dev_key_plus.png" alt="Bouton d'ajout d'une nouvelle clé" />
4. Nommez votre clé
    <img src="/social-login-assets/apple_key_name.png" alt="Champ de saisie du nom de la clé" />
    :::note
    Ce nom n'est pas important, vous pouvez mettre n'importe quoi.
    :::
5. Sélectionnez `Sign in with Apple` et cliquez sur `Configure`
    <img src="/social-login-assets/apple_dev_key_sing_apple_conf.png" alt="Activation et configuration de Sign in with Apple pour la clé" />
6. Sélectionnez l'App ID principal et appuyez sur `Save`
    <img src="/social-login-assets/apple_dev_key_prim_app_id.png" alt="Sélection de l'App ID principal pour la clé" />

    :::note
    Cela doit être le même App ID que l'ID dans les étapes précédentes.
    :::
7. Cliquez sur `Continue`
    <img src="/social-login-assets/apple_dev_key_const.png" alt="Bouton Continue pour la configuration de la clé" />
8. Cliquez sur `Register`
    <img src="/social-login-assets/apple_dev_key_reg.png" alt="Bouton Register pour la création de la clé" />
9. Copiez l'ID de clé et téléchargez la clé.
    <img src="/social-login-assets/apple_dev_key_downl.png" alt="Écran de l'ID de clé et du bouton de téléchargement" />

    :::caution
        **IMPORTANT:** Sauvegardez cet ID, dans le backend il sera appelé `KEY_ID`. Téléchargez la clé. Assurez-vous de ne jamais partager cette clé.
    :::
10. Trouvez la clé téléchargée et sauvegardez-la dans le dossier backend.
    <img src="/social-login-assets/apple_dev_downloaded_key.png" alt="Fichier de clé téléchargé" />
</Steps>

## Obtenir le Team ID

Pour utiliser `Login with Apple` sur Android, vous devez obtenir le `Team ID`. Il sera utilisé dans le backend.

<Steps>
   1. Allez sur [ce site web](https://developer.apple.com/account/) et faites défiler vers le bas

   2. Trouvez le `Team ID`
      <img src="/social-login-assets/apple_dev_team_id.png" alt="Emplacement du Team ID dans le compte développeur" />
</Steps>

## Configuration de la redirection de l'application

Comme vous l'avez vu dans le diagramme, le backend effectue une étape appelée `Redirect back to the app`. Cela nécessite des modifications manuelles de votre application.

<Steps>
    1. Modifiez le `AndroidManifest.xml`
        1. Ouvrez le fichier, j'utiliserai `AndroidStudio`
            <img src="/social-login-assets/studio_android_manifest_file.png" alt="Fichier AndroidManifest.xml dans Android Studio" />
        2. Trouvez la `MainActivity` et ajoutez le filtre d'intention suivant
            <img src="/social-login-assets/studio_manifest_code_to_add.png" alt="Code de filtre d'intention à ajouter dans MainActivity" />

            ```xml
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:scheme="capgo-demo-app" android:host="path" />
            </intent-filter>
            ```
    2. Modifiez la `MainActivity`
        1. Veuillez ouvrir la `MainActivity`
            <img src="/social-login-assets/studio_main_activ_file.png" alt="Fichier MainActivity.java dans Android Studio" />

        2. Ajoutez le code suivant :
            <img src="/social-login-assets/studio_main_actv_new_code.png" alt="Code à ajouter à MainActivity pour gérer les liens profonds" />

            ```java
            @Override
            protected void onNewIntent(Intent intent) {
                String action = intent.getAction();
                Uri data = intent.getData();

                if (Intent.ACTION_VIEW.equals(action) && data != null) {
                    PluginHandle pluginHandle = getBridge().getPlugin("SocialLogin");
                    if (pluginHandle == null) {
                        Log.i("Apple Login Intent", "SocialLogin login handle is null");
                        return;
                    }
                    Plugin plugin = pluginHandle.getInstance();
                    if (!(plugin instanceof SocialLoginPlugin)) {
                        Log.i("Apple Login Intent", "SocialLogin plugin instance is not SocialLoginPlugin");
                        return;
                    }
                    ((SocialLoginPlugin) plugin).handleAppleLoginIntent(intent);
                    return;
                }
                super.onNewIntent(intent);
            }
            ```

            :::caution
            Cet exemple suppose que vous n'avez aucun lien profond configuré. Si vous en avez, veuillez ajuster le code
            :::
</Steps>

:::note
Vous venez d'ajouter un nouveau lien profond dans votre application. Le lien profond ressemblera à quelque chose comme ceci : `capgo-demo-app://path`. Vous pouvez modifier le `android:scheme` et le `android:host` pour modifier l'apparence de ce lien profond.
**Important:** Dans la configuration du backend, ce lien profond deviendra `BASE_REDIRECT_URL`
:::


## Configuration du backend

Un backend est requis pour Android, mais la configuration d'un backend aura également un impact sur iOS. Un exemple de backend est fourni [ici](https://github.com/WcaleNieWolny/capgo-social-login-backend-demo/blob/main/index.ts)

Cet exemple fournit les éléments suivants :
- Une base de données JSON simple
- Un moyen de demander le JWT aux serveurs d'Apple
- Une simple vérification JWT

:::note
J'utilise `PM2` pour héberger cet exemple. Un exemple `ecosystem.config.js` peut être trouvé [ici](https://github.com/WcaleNieWolny/capgo-social-login-backend-demo/blob/main/ecosystem.config.js.example)
:::

Étant donné tout ce que j'ai dit dans ce tutoriel, voici à quoi ressemblerait la section `env` :

- `ANDROID_SERVICE_ID` = Service ID
- `IOS_SERVICE_ID` = App ID

```js
env: {
  PRIVATE_KEY_FILE: "AuthKey_U93M8LBQK3.p8",
  KEY_ID: "U93M8LBQK3",
  TEAM_ID: "UVTJ336J2D",
  ANDROID_SERVICE_ID: "ee.forgr.io.ionic.starter.service2",
  IOS_SERVICE_ID: "me.wcaleniewolny.test.ionic.vue",
  PORT: 3000,
  REDIRECT_URI: "https://xyz.wcaleniewolny.me/login/callback",
  BASE_REDIRECT_URL: "capgo-demo-app://path"
}
```

#### Utilisation du plugin

L'utilisation de la fonction `login` ne change pas, c'est la même chose que pour iOS. Veuillez consulter cette section pour plus d'informations. **CEPENDANT**, la méthode `initialize` change un peu.

```typescript
await SocialLogin.initialize({
  apple: {
    clientId: 'ee.forgr.io.ionic.starter.service2',
    redirectUrl: 'https://appleloginvps.wcaleniewolny.me/login/callback'
  }
})
```

:::danger
    Notez que l'ajout de `redirectUrl` **AFFECTERA** iOS !!!!!
:::


## Création de l'application

:::note
Si vous avez déjà un App ID, vous pouvez ignorer cette étape.
Ne suivez pas cette étape si vous avez configuré la connexion Apple pour iOS.
:::

<Steps>
   1. Si vous n'avez pas déjà un App ID, cliquez sur le bouton plus
        <img src="/social-login-assets/apple_dev_iden_plus.png" alt="Bouton plus pour ajouter un nouvel identifiant" />

   2. Sélectionnez `App IDs` et cliquez sur continuer
        <img src="/social-login-assets/apple_dev_new_app_id.png" alt="Sélection du type App IDs" />

   3. Cliquez sur le type `App` et cliquez sur `Continue`
        <img src="/social-login-assets/apple_dev_new_app_type.png" alt="Sélection du type App" />

   4. Entrez la description et l'app ID
        <img src="/social-login-assets/apple_dev_new_app_desc_id.png" alt="Saisie de la description de l'application et du bundle ID" />

   5. Activez la capacité `Sign with Apple`
        <img src="/social-login-assets/apple_dev_enable_sign_with_apple.png" alt="Activation de la capacité Sign in with Apple" />

   6. Cliquez sur `Continue`
        <img src="/social-login-assets/apple_dev_register_continue.png" alt="Bouton Continue pour l'enregistrement de l'application" />

   7. Confirmez les détails et cliquez sur `Register`
        <img src="/social-login-assets/apple_dev_confirm_register.png" alt="Confirmation des détails d'enregistrement de l'application" />
</Steps>
