---
title: Bitbucket Pipelines 集成
locale: zh
description: "了解如何将 Capgo Live Updates 与 Bitbucket Pipelines 集成,实现应用更新的自动化部署。"
sidebar:
  order: 4
---

import { Aside, Steps } from '@astrojs/starlight/components';

将 Capgo Live Updates 与 Bitbucket Pipelines 集成,在您推送代码更改时自动部署应用更新。本指南涵盖了自动化构建、测试和部署工作流的设置。

## 前置要求

在设置 Bitbucket Pipelines 集成之前,请确保您具备:

- 拥有存储库的 Bitbucket 账户
- 已配置应用的 Capgo 账户
- 项目中已配置 Node.js 和 npm/yarn

## 设置 Bitbucket Pipelines

### 步骤 1:配置存储库变量

首先,在您的 Bitbucket 存储库中设置必要的变量:

<Steps>

1. 导航到您的 Bitbucket 存储库
2. 进入 **Repository settings** → **Pipelines** → **Repository variables**
3. 添加以下变量:

</Steps>

| 变量名 | 值 | 加密 |
|---------------|-------|---------|
| `CAPGO_TOKEN` | 您的 Capgo API token | ✅ 是 |

<Aside type="tip">

从 [console.capgo.app/apikeys](https://console.capgo.app/apikeys) 获取您的 Capgo API token。您的应用 ID 已在 `capacitor.config.ts` 文件中配置。

</Aside>

## 简单配置

基本配置,在每次推送到主分支时部署到生产环境:

```yaml
# bitbucket-pipelines.yml - 简单配置
image: node:22

pipelines:
  branches:
    main:
      - step:
          name: Build and Deploy to Production
          script:
            - npm ci
            - npm run test
            - npm run build
            - npm install -g @capgo/cli
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel production
          artifacts:
            - dist/**
```

## 高级配置

### 功能分支部署

将功能分支部署到测试渠道以供审查和测试:

```yaml
# 功能分支部署
pipelines:
  branches:
    feature/*:
      - step:
          name: Deploy Feature Branch
          script:
            - npm ci
            - npm run test
            - npm run build
            - BRANCH_NAME=$(echo $BITBUCKET_BRANCH | sed 's/[^a-zA-Z0-9-]/-/g')
            - CHANNEL_NAME="feature-$BRANCH_NAME"
            - npm install -g @capgo/cli
            - npx @capgo/cli channel create $CHANNEL_NAME --apikey $CAPGO_TOKEN || true
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel $CHANNEL_NAME
          artifacts:
            - dist/**
```

<Aside type="tip">

**使用渠道进行测试**:部署到功能渠道后,您可以通过配置应用使用该特定渠道来测试更新。了解更多关于[在应用中配置渠道](/docs/live-updates/channels/#configuring-the-channel-in-your-app)的信息。

</Aside>

### 使用加密

如果您使用 [Capgo 的加密功能](/docs/live-updates/encryption/),则需要在 CI/CD 环境中安全地存储您的私钥。

在本地[设置加密密钥](/docs/live-updates/encryption/#setting-up-encryption)后,将您的私钥添加到 Bitbucket 变量:

```shell
# 显示您的私钥内容(复制此输出)
cat .capgo_key_v2
```

将此内容作为 `CAPGO_PRIVATE_KEY` 添加到您的 Bitbucket 存储库变量(标记为加密),然后在管道中使用它:

```yaml
# 使用加密部署
- step:
    name: Deploy to Capgo with Encryption
    script:
      - npm install -g @capgo/cli
      - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --key-data-v2 "$CAPGO_PRIVATE_KEY" --channel production
```

<Aside type="caution">

**安全最佳实践:**
- 切勿将 `.capgo_key_v2` 文件提交到版本控制
- 仅在安全的 CI/CD 密钥管理中存储私钥
- 为不同环境使用不同的密钥

</Aside>

### 多渠道配置

有关设置和管理多个部署渠道的综合信息,请参阅[渠道文档](/docs/live-updates/channels/)。

包含多个环境和拉取请求部署的完整配置:

```yaml
# bitbucket-pipelines.yml - 高级多渠道配置
image: node:22

definitions:
  steps:
    - step: &build-step
        name: Build Application
        script:
          - npm ci
          - npm run test
          - npm run build
        artifacts:
          - dist/**

    - step: &deploy-step
        name: Deploy to Capgo
        script:
          - npm install -g @capgo/cli
          - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel $CHANNEL_NAME

pipelines:
  branches:
    main:
      - step:
          <<: *build-step
      - step:
          <<: *deploy-step
          name: Deploy to Production
          deployment: production
          trigger: manual
          script:
            - export CHANNEL_NAME=production
            - npm install -g @capgo/cli
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel $CHANNEL_NAME

    develop:
      - step:
          <<: *build-step
      - step:
          <<: *deploy-step
          name: Deploy to Development
          deployment: development
          script:
            - export CHANNEL_NAME=development
            - npm install -g @capgo/cli
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel $CHANNEL_NAME

  pull-requests:
    '**':
      - step:
          <<: *build-step
      - step:
          name: Deploy PR to Test Channel
          script:
            - CHANNEL_NAME="pr-$BITBUCKET_PR_ID"
            - npm install -g @capgo/cli
            - npx @capgo/cli channel create $CHANNEL_NAME --apikey $CAPGO_TOKEN || true
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel $CHANNEL_NAME
          artifacts:
            - dist/**
```

### 多环境管道

对于具有预发布和生产环境的复杂部署场景:

```yaml
# 多环境管道
image: node:22

pipelines:
  branches:
    main:
      - step:
          name: Build
          script:
            - npm ci
            - npm run test
            - npm run build
          artifacts:
            - dist/**
      - step:
          name: Deploy to Staging
          deployment: staging
          script:
            - npm install -g @capgo/cli
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel staging
      - step:
          name: Deploy to Production
          deployment: production
          trigger: manual
          script:
            - npm install -g @capgo/cli
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel production

    develop:
      - step:
          name: Build and Deploy to Development
          script:
            - npm ci
            - npm run test
            - npm run build
            - npm install -g @capgo/cli
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel development
          artifacts:
            - dist/**
```

### 基于分支的部署策略

自动将不同分支部署到适当的渠道:

```yaml
# 动态渠道部署
image: node:22

definitions:
  scripts:
    - script: &determine-channel |
        if [ "$BITBUCKET_BRANCH" = "main" ]; then
          export CHANNEL_NAME="production"
        elif [ "$BITBUCKET_BRANCH" = "develop" ]; then
          export CHANNEL_NAME="staging"
        else
          export CHANNEL_NAME="development"
        fi
        echo "Deploying to channel: $CHANNEL_NAME"

pipelines:
  default:
    - step:
        name: Build and Deploy
        script:
          - npm ci
          - npm run test
          - npm run build
          - *determine-channel
          - npm install -g @capgo/cli
          - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel $CHANNEL_NAME
        artifacts:
          - dist/**
```

### 并行管道执行

使用并行步骤优化构建时间:

```yaml
# 并行执行管道
image: node:22

pipelines:
  branches:
    main:
      - parallel:
          - step:
              name: Run Tests
              script:
                - npm ci
                - npm run test
          - step:
              name: Lint Code
              script:
                - npm ci
                - npm run lint
      - step:
          name: Build Application
          script:
            - npm ci
            - npm run build
          artifacts:
            - dist/**
      - step:
          name: Deploy to Production
          deployment: production
          script:
            - npm install -g @capgo/cli
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel production
```

## 安全最佳实践

### 存储库变量

<Steps>

1. **加密变量**:始终将 API token 标记为加密
2. **环境变量**:在需要时使用特定于部署的变量
3. **访问控制**:将存储库访问权限限制为授权的团队成员
4. **Token 轮换**:定期轮换您的 Capgo API token

</Steps>

### 部署环境

配置部署环境以提高安全性:

```yaml
# 具有环境限制的部署
pipelines:
  branches:
    main:
      - step:
          name: Deploy to Production
          deployment: production
          trigger: manual
          script:
            - npm install -g @capgo/cli
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel production
```

## 监控和通知

### Slack 集成

向管道添加 Slack 通知:

```yaml
# 带有 Slack 通知的管道
pipelines:
  branches:
    main:
      - step:
          name: Build and Deploy
          script:
            - npm ci
            - npm run test
            - npm run build
            - npm install -g @capgo/cli
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel production
          after-script:
            - |
              if [ $BITBUCKET_EXIT_CODE -eq 0 ]; then
                curl -X POST -H 'Content-type: application/json' \
                  --data '{"text":"✅ Capgo deployment successful for '$BITBUCKET_BRANCH'"}' \
                  $SLACK_WEBHOOK_URL
              else
                curl -X POST -H 'Content-type: application/json' \
                  --data '{"text":"❌ Capgo deployment failed for '$BITBUCKET_BRANCH'"}' \
                  $SLACK_WEBHOOK_URL
              fi
```

### 邮件通知

通过 Bitbucket 的内置功能或使用外部服务配置邮件通知:

```yaml
# 邮件通知步骤
- step:
    name: Send Notification
    script:
      - |
        curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "to": "team@yourcompany.com",
            "subject": "Capgo Deployment Status",
            "body": "Deployment of '$BITBUCKET_BRANCH' completed with status: '$BITBUCKET_EXIT_CODE'"
          }' \
          $EMAIL_SERVICE_URL
    condition:
      result: [successful, failed]
```

## 故障排除

### 常见问题

**管道失败并显示 "Capgo CLI not found":**
```yaml
# 调试 CLI 安装
- step:
    name: Debug CLI
    script:
      - npm install -g @capgo/cli
      - which capgo || echo "Capgo CLI not found"
      - npx @capgo/cli --version
```

**身份验证错误:**
```yaml
# 验证 token 配置
- step:
    name: Debug Auth
    script:
      - |
        if [ -z "$CAPGO_TOKEN" ]; then
          echo "CAPGO_TOKEN is not set"
          exit 1
        fi
        echo "Token length: ${#CAPGO_TOKEN}"
```

**找不到构建产物:**
```yaml
# 列出构建输出
- step:
    name: Debug Build
    script:
      - ls -la dist/
      - find dist/ -type f -name "*.js" -o -name "*.html"
```

### 调试管道

添加调试信息以解决问题:

```yaml
# 调试管道
pipelines:
  branches:
    main:
      - step:
          name: Debug Information
          script:
            - echo "Branch: $BITBUCKET_BRANCH"
            - echo "Commit: $BITBUCKET_COMMIT"
            - echo "Build: $BITBUCKET_BUILD_NUMBER"
            - env | grep BITBUCKET_ | sort
      - step:
          name: Build and Deploy
          script:
            - npm ci
            - npm run test
            - npm run build
            - npm install -g @capgo/cli
            - npx @capgo/cli bundle upload --apikey $CAPGO_TOKEN --channel production
```

### 管道验证

启用管道验证以捕获配置错误:

```yaml
# 启用管道验证
options:
  docker: true
  size: 2x

pipelines:
  branches:
    main:
      - step:
          name: Validate Pipeline
          script:
            - echo "Pipeline validation successful"
      - step:
          name: Build and Deploy
          script:
            # ... 部署步骤
```

## 下一步

- 了解[渠道](/docs/live-updates/channels/)以管理不同的部署环境
- 探索[自定义存储](/docs/live-updates/custom-storage/)以进行高级部署场景
- 设置[加密](/docs/live-updates/encryption/)以进行安全部署
- 配置[更新行为](/docs/live-updates/update-behavior/)以自定义更新的应用方式

通过 Bitbucket Pipelines 集成,您可以自动化 Capgo 部署,并确保为移动应用用户提供一致、可靠的更新。
