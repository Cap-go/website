---
import type { StarlightRouteData } from '@astrojs/starlight/route-data'

const { entry } = Astro.locals.starlightRoute as StarlightRouteData
const pageSlug = entry?.slug || ''
---

<div class="copy-page-container">
  <button class="copy-page-button" aria-label="Copy page options" data-page-slug={pageSlug}>
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
      <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
    </svg>
    <span>Copy page</span>
    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron">
      <path d="m6 9 6 6 6-6"/>
    </svg>
  </button>

  <div class="copy-page-menu" role="menu" hidden>
    <button class="menu-item copy-markdown" role="menuitem">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
      </svg>
      <div>
        <div class="menu-item-title">Copy page</div>
        <div class="menu-item-subtitle">Copy page as Markdown for LLMs</div>
      </div>
    </button>

    <a class="menu-item view-markdown" role="menuitem" target="_blank" rel="noopener noreferrer">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <text x="2" y="18" font-size="20" font-weight="bold" fill="currentColor">Mâ†“</text>
      </svg>
      <div>
        <div class="menu-item-title">View as Markdown</div>
        <div class="menu-item-subtitle">View this page as plain text</div>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon">
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
        <polyline points="15 3 21 3 21 9"/>
        <line x1="10" x2="21" y1="14" y2="3"/>
      </svg>
    </a>

    <button class="menu-item open-chatgpt" role="menuitem">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4"/>
        <path d="M12 8h.01"/>
      </svg>
      <div>
        <div class="menu-item-title">Open in ChatGPT</div>
        <div class="menu-item-subtitle">Ask questions about this page</div>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon">
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
        <polyline points="15 3 21 3 21 9"/>
        <line x1="10" x2="21" y1="14" y2="3"/>
      </svg>
    </button>

    <button class="menu-item open-claude" role="menuitem">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
        <path d="M2 17l10 5 10-5"/>
        <path d="M2 12l10 5 10-5"/>
      </svg>
      <div>
        <div class="menu-item-title">Open in Claude</div>
        <div class="menu-item-subtitle">Ask questions about this page</div>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon">
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
        <polyline points="15 3 21 3 21 9"/>
        <line x1="10" x2="21" y1="14" y2="3"/>
      </svg>
    </button>

    <button class="menu-item open-perplexity" role="menuitem">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
      </svg>
      <div>
        <div class="menu-item-title">Open in Perplexity</div>
        <div class="menu-item-subtitle">Ask questions about this page</div>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon">
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
        <polyline points="15 3 21 3 21 9"/>
        <line x1="10" x2="21" y1="14" y2="3"/>
      </svg>
    </button>
  </div>
</div>

<script>
  // Toggle menu visibility
  const buttons = document.querySelectorAll('.copy-page-button')
  buttons.forEach((button) => {
    button.addEventListener('click', (e) => {
      e.stopPropagation()
      const menu = button.nextElementSibling as HTMLElement
      const isHidden = menu.hidden

      // Close all other menus
      document.querySelectorAll('.copy-page-menu').forEach((m) => {
        if (m !== menu) (m as HTMLElement).hidden = true
      })

      menu.hidden = !isHidden
    })
  })

  // Close menu when clicking outside
  document.addEventListener('click', () => {
    document.querySelectorAll('.copy-page-menu').forEach((menu) => {
      (menu as HTMLElement).hidden = true
    })
  })

  // Copy page as markdown
  document.querySelectorAll('.copy-markdown').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault()
      e.stopPropagation()

      const pageSlug = document.querySelector('.copy-page-button')?.getAttribute('data-page-slug')
      if (!pageSlug) {
        console.error('Page slug not found')
        return
      }

      const title = btn.querySelector('.menu-item-title')
      const originalText = title?.textContent

      try {
        // Disable button during operation
        ;(btn as HTMLButtonElement).disabled = true

        // Fetch the markdown content from the local .md file
        const mdPath = `/${pageSlug}.md`
        console.log('Fetching markdown from:', mdPath)
        const response = await fetch(mdPath)

        if (!response.ok) {
          throw new Error(`Failed to fetch markdown: ${response.status} ${response.statusText}`)
        }

        const content = await response.text()
        console.log('Fetched content length:', content.length)

        // Try using the older execCommand fallback if clipboard API fails
        try {
          await navigator.clipboard.writeText(content)
          console.log('Copied to clipboard successfully')
        } catch (clipboardError) {
          console.error('Clipboard API failed, trying fallback:', clipboardError)

          // Fallback method using textarea
          const textarea = document.createElement('textarea')
          textarea.value = content
          textarea.style.position = 'fixed'
          textarea.style.opacity = '0'
          document.body.appendChild(textarea)
          textarea.select()
          document.execCommand('copy')
          document.body.removeChild(textarea)
        }

        // Show success feedback
        if (title) {
          title.textContent = 'Copied!'
          setTimeout(() => {
            title.textContent = originalText || 'Copy page'
          }, 2000)
        }
      } catch (error) {
        console.error('Failed to copy:', error)
        if (title) {
          title.textContent = 'Failed to copy'
          setTimeout(() => {
            title.textContent = originalText || 'Copy page'
          }, 2000)
        }
      } finally {
        ;(btn as HTMLButtonElement).disabled = false
      }
    })
  })

  // View as Markdown - set the href to local .md file
  document.querySelectorAll('.view-markdown').forEach((link) => {
    const pageSlug = document.querySelector('.copy-page-button')?.getAttribute('data-page-slug')
    if (pageSlug) {
      // Link to the local .md file served by vite-plugin-static-copy
      ;(link as HTMLAnchorElement).href = `/${pageSlug}.md`
    }
  })

  // Get markdown URL - use absolute URL for AI assistants
  function getMarkdownUrl(): string {
    const pageSlug = document.querySelector('.copy-page-button')?.getAttribute('data-page-slug')
    if (!pageSlug) return window.location.href

    // Return absolute URL to the local .md file
    const baseUrl = window.location.origin
    return `${baseUrl}/${pageSlug}.md`
  }

  // Open in AI assistants - pass markdown URL
  document.querySelectorAll('.open-chatgpt').forEach((btn) => {
    btn.addEventListener('click', () => {
      const markdownUrl = getMarkdownUrl()
      window.open(`https://chat.openai.com/?q=${encodeURIComponent(`Please help me understand this documentation: ${markdownUrl}`)}`, '_blank')
    })
  })

  document.querySelectorAll('.open-claude').forEach((btn) => {
    btn.addEventListener('click', () => {
      const markdownUrl = getMarkdownUrl()
      window.open(`https://claude.ai/new?q=${encodeURIComponent(`Please help me understand this documentation: ${markdownUrl}`)}`, '_blank')
    })
  })

  document.querySelectorAll('.open-perplexity').forEach((btn) => {
    btn.addEventListener('click', () => {
      const markdownUrl = getMarkdownUrl()
      window.open(`https://www.perplexity.ai/?q=${encodeURIComponent(`Please help me understand this documentation: ${markdownUrl}`)}`, '_blank')
    })
  })
</script>

<style>
  .copy-page-container {
    position: relative;
    display: inline-block;
  }

  .copy-page-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    color: var(--sl-color-text);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .copy-page-button:hover {
    background: var(--sl-color-gray-6);
    border-color: var(--sl-color-gray-4);
  }

  .copy-page-button .chevron {
    transition: transform 0.2s;
  }

  .copy-page-button:hover .chevron {
    transform: translateY(1px);
  }

  .copy-page-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 20rem;
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    padding: 0.5rem;
    z-index: 1000;
  }

  .menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.75rem;
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    color: var(--sl-color-text);
    text-align: left;
    text-decoration: none;
    cursor: pointer;
    transition: background 0.2s;
  }

  .menu-item:hover {
    background: var(--sl-color-gray-6);
  }

  .menu-item > svg:first-child {
    flex-shrink: 0;
    color: var(--sl-color-text-accent);
  }

  .menu-item > div {
    flex: 1;
  }

  .menu-item-title {
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.25;
  }

  .menu-item-subtitle {
    font-size: 0.75rem;
    color: var(--sl-color-gray-3);
    line-height: 1.25;
  }

  .external-icon {
    flex-shrink: 0;
    opacity: 0.5;
  }

  @media (max-width: 768px) {
    .copy-page-menu {
      right: auto;
      left: 0;
    }
  }
</style>
