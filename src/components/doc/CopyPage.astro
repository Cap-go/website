---
import type { StarlightRouteData } from '@astrojs/starlight/route-data'
import * as m from '@/paraglide/messages'

const { entry } = Astro.locals.starlightRoute as StarlightRouteData
const pageSlug = entry?.slug || ''

const translations = {
  copyPage: m.copy_page({}, { locale: Astro.locals.locale }),
  copyPageOptions: m.copy_page_options({}, { locale: Astro.locals.locale }),
  copyPageAsMarkdown: m.copy_page_as_markdown({}, { locale: Astro.locals.locale }),
  viewAsMarkdown: m.view_as_markdown({}, { locale: Astro.locals.locale }),
  viewPageAsPlainText: m.view_page_as_plain_text({}, { locale: Astro.locals.locale }),
  openInChatgpt: m.open_in_chatgpt({}, { locale: Astro.locals.locale }),
  openInClaude: m.open_in_claude({}, { locale: Astro.locals.locale }),
  openInPerplexity: m.open_in_perplexity({}, { locale: Astro.locals.locale }),
  askQuestionsAboutPage: m.ask_questions_about_page({}, { locale: Astro.locals.locale }),
  copied: m.copied({}, { locale: Astro.locals.locale }),
  failedToCopy: m.failed_to_copy({}, { locale: Astro.locals.locale }),
}
---

<div class="copy-page-container">
  <button class="copy-page-button" aria-label={translations.copyPageOptions} data-page-slug={pageSlug}>
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
      <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
    </svg>
    <span>{translations.copyPage}</span>
    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron">
      <path d="m6 9 6 6 6-6"/>
    </svg>
  </button>

  <div class="copy-page-menu" role="menu" hidden>
    <button class="menu-item copy-markdown" role="menuitem">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
      </svg>
      <div>
        <div class="menu-item-title">{translations.copyPage}</div>
        <div class="menu-item-subtitle">{translations.copyPageAsMarkdown}</div>
      </div>
    </button>

    <a class="menu-item view-markdown" role="menuitem" target="_blank" rel="noopener noreferrer">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <text x="2" y="18" font-size="20" font-weight="bold" fill="currentColor">Mâ†“</text>
      </svg>
      <div>
        <div class="menu-item-title">{translations.viewAsMarkdown}</div>
        <div class="menu-item-subtitle">{translations.viewPageAsPlainText}</div>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon">
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
        <polyline points="15 3 21 3 21 9"/>
        <line x1="10" x2="21" y1="14" y2="3"/>
      </svg>
    </a>

    <button class="menu-item open-chatgpt" role="menuitem">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4"/>
        <path d="M12 8h.01"/>
      </svg>
      <div>
        <div class="menu-item-title">{translations.openInChatgpt}</div>
        <div class="menu-item-subtitle">{translations.askQuestionsAboutPage}</div>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon">
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
        <polyline points="15 3 21 3 21 9"/>
        <line x1="10" x2="21" y1="14" y2="3"/>
      </svg>
    </button>

    <button class="menu-item open-claude" role="menuitem">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
        <path d="M2 17l10 5 10-5"/>
        <path d="M2 12l10 5 10-5"/>
      </svg>
      <div>
        <div class="menu-item-title">{translations.openInClaude}</div>
        <div class="menu-item-subtitle">{translations.askQuestionsAboutPage}</div>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon">
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
        <polyline points="15 3 21 3 21 9"/>
        <line x1="10" x2="21" y1="14" y2="3"/>
      </svg>
    </button>

    <button class="menu-item open-perplexity" role="menuitem">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
      </svg>
      <div>
        <div class="menu-item-title">{translations.openInPerplexity}</div>
        <div class="menu-item-subtitle">{translations.askQuestionsAboutPage}</div>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon">
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
        <polyline points="15 3 21 3 21 9"/>
        <line x1="10" x2="21" y1="14" y2="3"/>
      </svg>
    </button>
  </div>
</div>

<script is:inline define:vars={{ translations }}>
  // Toggle menu visibility
  const buttons = document.querySelectorAll('.copy-page-button')
  buttons.forEach((button) => {
    button.addEventListener('click', (e) => {
      e.stopPropagation()
      const menu = button.nextElementSibling
      const isHidden = menu.hidden

      // Close all other menus
      document.querySelectorAll('.copy-page-menu').forEach((m) => {
        if (m !== menu) m.hidden = true
      })

      menu.hidden = !isHidden
    })
  })

  // Close menu when clicking outside
  document.addEventListener('click', () => {
    document.querySelectorAll('.copy-page-menu').forEach((menu) => {
      menu.hidden = true
    })
  })

  // Copy page as markdown
  document.querySelectorAll('.copy-markdown').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault()
      e.stopPropagation()

      const pageSlug = document.querySelector('.copy-page-button')?.getAttribute('data-page-slug')
      if (!pageSlug) {
        console.error('Page slug not found')
        return
      }

      const title = btn.querySelector('.menu-item-title')
      const originalText = title?.textContent

      try {
        // Disable button during operation
        btn.disabled = true

        // Try multiple paths for the markdown file
        const paths = [
          `/${pageSlug}.md`,  // Built/copied version
          `/src/content/docs/${pageSlug}.mdx`,  // Dev mode .mdx
          `/src/content/docs/${pageSlug}.md`,   // Dev mode .md
        ]

        let content = ''
        let fetchSuccess = false

        for (const mdPath of paths) {
          try {
            console.log('Trying to fetch from:', mdPath)
            const response = await fetch(mdPath)
            if (response.ok) {
              content = await response.text()
              console.log('Successfully fetched from:', mdPath, 'Length:', content.length)
              fetchSuccess = true
              break
            }
          } catch (err) {
            console.log('Failed to fetch from:', mdPath)
          }
        }

        if (!fetchSuccess || !content) {
          throw new Error('Failed to fetch markdown from any source')
        }

        // Copy to clipboard using the most reliable method
        try {
          await navigator.clipboard.writeText(content)
          console.log('Copied to clipboard successfully')
        } catch (clipboardError) {
          console.error('Clipboard API failed, trying fallback:', clipboardError)

          // Fallback method using textarea
          const textarea = document.createElement('textarea')
          textarea.value = content
          textarea.style.position = 'fixed'
          textarea.style.opacity = '0'
          document.body.appendChild(textarea)
          textarea.focus()
          textarea.select()
          const success = document.execCommand('copy')
          document.body.removeChild(textarea)

          if (!success) {
            throw new Error('Fallback copy method also failed')
          }
        }

        // Show success feedback
        if (title) {
          title.textContent = translations.copied
          setTimeout(() => {
            title.textContent = originalText || translations.copyPage
          }, 2000)
        }
      } catch (error) {
        console.error('Failed to copy:', error)
        if (title) {
          title.textContent = translations.failedToCopy
          setTimeout(() => {
            title.textContent = originalText || translations.copyPage
          }, 2000)
        }
      } finally {
        btn.disabled = false
      }
    })
  })

  // View as Markdown - set the href to local .md file
  document.querySelectorAll('.view-markdown').forEach((link) => {
    const pageSlug = document.querySelector('.copy-page-button')?.getAttribute('data-page-slug')
    if (pageSlug) {
      // Link to the local .md file served by vite-plugin-static-copy
      link.href = `/${pageSlug}.md`
    }
  })

  // Get markdown URL - use absolute URL for AI assistants
  function getMarkdownUrl() {
    const pageSlug = document.querySelector('.copy-page-button')?.getAttribute('data-page-slug')
    if (!pageSlug) return window.location.href

    // Return absolute URL to the local .md file
    const baseUrl = window.location.origin
    return `${baseUrl}/${pageSlug}.md`
  }

  // Open in AI assistants - pass markdown URL
  document.querySelectorAll('.open-chatgpt').forEach((btn) => {
    btn.addEventListener('click', () => {
      const markdownUrl = getMarkdownUrl()
      window.open(`https://chat.openai.com/?q=${encodeURIComponent(`Please help me understand this documentation: ${markdownUrl}`)}`, '_blank')
    })
  })

  document.querySelectorAll('.open-claude').forEach((btn) => {
    btn.addEventListener('click', () => {
      const markdownUrl = getMarkdownUrl()
      window.open(`https://claude.ai/new?q=${encodeURIComponent(`Please help me understand this documentation: ${markdownUrl}`)}`, '_blank')
    })
  })

  document.querySelectorAll('.open-perplexity').forEach((btn) => {
    btn.addEventListener('click', () => {
      const markdownUrl = getMarkdownUrl()
      window.open(`https://www.perplexity.ai/?q=${encodeURIComponent(`Please help me understand this documentation: ${markdownUrl}`)}`, '_blank')
    })
  })
</script>

<style>
  .copy-page-container {
    position: relative;
    display: inline-block;
  }

  .copy-page-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    color: var(--sl-color-text);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .copy-page-button:hover {
    background: var(--sl-color-gray-6);
    border-color: var(--sl-color-gray-4);
  }

  .copy-page-button .chevron {
    transition: transform 0.2s;
  }

  .copy-page-button:hover .chevron {
    transform: translateY(1px);
  }

  .copy-page-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 20rem;
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    padding: 0.5rem;
    z-index: 1000;
  }

  .menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.75rem;
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    color: var(--sl-color-text);
    text-align: left;
    text-decoration: none;
    cursor: pointer;
    transition: background 0.2s;
  }

  .menu-item:hover {
    background: var(--sl-color-gray-6);
  }

  .menu-item > svg:first-child {
    flex-shrink: 0;
    color: var(--sl-color-text-accent);
  }

  .menu-item > div {
    flex: 1;
  }

  .menu-item-title {
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.25;
  }

  .menu-item-subtitle {
    font-size: 0.75rem;
    color: var(--sl-color-gray-3);
    line-height: 1.25;
  }

  .external-icon {
    flex-shrink: 0;
    opacity: 0.5;
  }

  @media (max-width: 768px) {
    .copy-page-menu {
      right: auto;
      left: 0;
    }
  }
</style>
