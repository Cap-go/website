---
import Layout from '@/layouts/Layout.astro'
import SponsorLogo from '@/components/SponsorLogo.astro'
import * as m from '@/paraglide/messages'

interface Sponsor {
  id: string
  name: string
  imageUrl: string
  url: string
  tier?: string
}

const fetchSponsors = async (): Promise<Sponsor[]> => {
  const query = `
    query {
      riderx: user(login: "riderx") {
        sponsorshipsAsMaintainer(first: 100) {
          nodes {
            sponsorEntity {
              ... on User {
                login
                name
                url
                avatarUrl
              }
              ... on Organization {
                login
                avatarUrl
                url
                name
              }
            }
            isActive
            tier {
              monthlyPriceInDollars
            }
          }
        }
      }
      capgo: organization(login: "Cap-go") {
        sponsorshipsAsMaintainer(first: 100) {
          nodes {
            sponsorEntity {
              ... on User {
                login
                name
                avatarUrl
                url
              }
              ... on Organization {
                login
                avatarUrl
                url
                name
              }
            }
            isActive
            tier {
              monthlyPriceInDollars
            }
          }
        }
      }
    }
  `

  try {
    const response = await fetch('https://api.github.com/graphql', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${import.meta.env.PERSONAL_ACCESS_TOKEN}`,
      },
      body: JSON.stringify({ query }),
    })
    const data = await response.json()
    if (data.errors) {
      console.error('GraphQL Errors:', data.errors)
      return []
    }
    const riderxNodes = data?.data?.riderx?.sponsorshipsAsMaintainer?.nodes || []
    const capgoNodes = data?.data?.capgo?.sponsorshipsAsMaintainer?.nodes || []
    const allSponsors = [...riderxNodes, ...capgoNodes]
    const calculateTier = (sponsorship: any) => {
      const tier = sponsorship?.tier?.monthlyPriceInDollars ?? 0
      if (tier >= 100) {
        return 'platinum'
      } else if (tier >= 50) {
        return 'gold'
      } else if (tier >= 25) {
        return 'silver'
      } else {
        return 'baker'
      }
    }
    return allSponsors.map((sponsorship) => {
      const sponsor = sponsorship.sponsorEntity
      return {
        id: sponsor.login,
        name: sponsor.name || sponsor.login,
        imageUrl: sponsor.avatarUrl,
        url: sponsor.url,
        tier: calculateTier(sponsorship),
      }
    })
  } catch (error) {
    console.error('Error fetching sponsors:', error)
    return []
  }
}

const sponsors = await fetchSponsors()
const bakerSponsors = sponsors.filter((sponsor) => sponsor.tier === 'baker')
const silverSponsors = sponsors.filter((sponsor) => sponsor.tier === 'silver')
const goldSponsors = sponsors.filter((sponsor) => sponsor.tier === 'gold')
const platinumSponsors = sponsors.filter((sponsor) => sponsor.tier === 'platinum')
---

<Layout>
  <div class="py-16 px-4 min-h-screen text-white bg-gray-900 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl">
      <h1 class="mb-4 text-4xl font-bold">{m.sponsor_title({}, { locale: Astro.locals.locale })}</h1>
      <p class="mb-8 max-w-3xl text-xl text-gray-300">
        {m.sponsor_description({}, { locale: Astro.locals.locale })}
      </p>
      <a
        href="https://github.com/sponsors/riderx"
        class="inline-block py-3 px-6 mb-16 font-semibold text-gray-900 bg-white rounded-lg transition-colors duration-300 hover:bg-gray-200"
      >
        {m.become_a_sponsor({}, { locale: Astro.locals.locale })}
      </a>
      {
        platinumSponsors.length > 0 && (
          <div class="mb-16">
            <h2 class="mb-8 text-2xl font-bold">{m.tier_platinum({}, { locale: Astro.locals.locale })}</h2>
            <div class="grid grid-cols-2 gap-x-4 gap-8 -mt-4 sm:grid-cols-3 md:grid-cols-4">
              {platinumSponsors.map((sponsor) => (
                <SponsorLogo size={24} name={sponsor.name} logo={sponsor.imageUrl} url={sponsor.url} />
              ))}
            </div>
          </div>
        )
      }
      {
        goldSponsors.length > 0 && (
          <div>
            <h2 class="mb-8 text-2xl font-bold">{m.tier_gold({}, { locale: Astro.locals.locale })}</h2>
            <div class="grid grid-cols-3 gap-x-4 gap-8 -mt-4 sm:grid-cols-4 md:grid-cols-5">
              {goldSponsors.map((sponsor) => (
                <SponsorLogo size={20} name={sponsor.name} logo={sponsor.imageUrl} url={sponsor.url} />
              ))}
            </div>
          </div>
        )
      }
      {
        silverSponsors.length > 0 && (
          <div>
            <h2 class="mb-8 text-2xl font-bold">{m.tier_silver({}, { locale: Astro.locals.locale })}</h2>
            <div class="grid grid-cols-4 gap-x-4 gap-8 -mt-4 sm:grid-cols-5 md:grid-cols-6">
              {silverSponsors.map((sponsor) => (
                <SponsorLogo size={16} name={sponsor.name} logo={sponsor.imageUrl} url={sponsor.url} />
              ))}
            </div>
          </div>
        )
      }
      {
        bakerSponsors.length > 0 && (
          <div>
            <h2 class="mb-8 text-2xl font-bold">{m.tier_baker({}, { locale: Astro.locals.locale })}</h2>
            <div class="flex flex-wrap gap-8 ml-12">
              {bakerSponsors.map((sponsor) => (
                <SponsorLogo size={14} name={sponsor.name} logo={sponsor.imageUrl} url={sponsor.url} />
              ))}
            </div>
          </div>
        )
      }
    </div>
  </div>
</Layout>
