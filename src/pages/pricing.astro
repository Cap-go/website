---
import Layout from '@/layouts/Layout.astro'
import CreditPricing from '@/components/pricing/CreditPricing.astro'
import Faq from '@/components/pricing/Faq.astro'
import { getRelativeLocaleUrl } from 'astro:i18n'
import Plans from '@/components/pricing/Plans.astro'
import { createLdJsonGraph, createProductLdJson, createFAQPageLdJson } from '@/lib/ldJson'
import type { Database } from '@/services/supabase.types'
import * as m from '@/paraglide/messages'
import Enterprise from '@/components/enterprise.astro'

const title = [Astro.locals.runtimeConfig.public.brand, m.pricing({}, { locale: Astro.locals.locale })].join(' | ')
const description = m.pricing_description({}, { locale: Astro.locals.locale })

const content: { title: string; description: string; ldJSON?: any } = { title, description }

const config = Astro.locals.runtimeConfig

let yearly = true
let plansAll: Database['public']['Tables']['plans']['Row'][] = []
let credits: any[] = []

// Fetch plans data
const response = await fetch(`${config.public.baseApiUrl}/private/plans`)
plansAll = await response.json()

// Fetch credits data
const creditsResponse = await fetch(`${config.public.baseApiUrl}/private/credits`)
credits = await creditsResponse.json()

// Filter plans
const plans = plansAll.length ? plansAll.filter((p) => p.name !== 'Free') : []
const payg = plansAll.length ? plansAll.filter((p) => p.name === 'Enterprise')[0] : undefined

// Create ldJSON for pricing plans
if (plans.length > 0) {
  const pricingUrl = getRelativeLocaleUrl(Astro.locals.locale, '/pricing/')

  // Create product schemas for each plan
  const planProducts = plans.map((plan) =>
    createProductLdJson(Astro.locals.runtimeConfig.public, {
      name: plan.name,
      description: plan.description || `Capgo ${plan.name} plan`,
      url: pricingUrl,
      sku: plan.id.toString(),
      offers: [
        {
          price: (plan as any).price_monthly?.toString() || plan.price_m?.toString() || '0',
          priceCurrency: 'USD',
          availability: 'https://schema.org/InStock',
          priceValidUntil: (plan as any).trial_days ? new Date(Date.now() + (plan as any).trial_days * 24 * 60 * 60 * 1000).toISOString().split('T')[0] : undefined,
        },
      ],
    }),
  )

  // Create FAQ schema for pricing FAQs
  const faqSchema = createFAQPageLdJson(Astro.locals.runtimeConfig.public, {
    url: pricingUrl,
    questions: [
      { question: 'How are MAU counted?', answer: 'MAU (Monthly Active Users) are counted as unique users who open your app at least once in a 30-day period. Each unique device is counted once per month.' },
      { question: 'What is storage used for?', answer: 'Storage is used for your app bundles and assets. Each version of your app you upload counts towards your storage limit.' },
      { question: 'How is bandwidth counted?', answer: 'Bandwidth is counted when users download updates. Each download of your app bundle uses bandwidth from your plan.' },
      { question: 'What happens if I reach my MAU limit?', answer: 'If you reach your MAU limit, new users will still receive updates but you may need to upgrade your plan to continue tracking all users.' },
      { question: 'Can I change my plan at any time?', answer: 'Yes, you can upgrade or downgrade your plan at any time. Changes take effect immediately and billing is prorated.' },
      { question: 'Do you offer refunds?', answer: 'We offer a 14-day money-back guarantee on all plans. Contact support for refund requests.' },
      { question: 'What payment methods do you accept?', answer: 'We accept all major credit cards, debit cards, and for Enterprise plans, ACH transfers and wire payments.' },
    ],
  })

  // Create ldJSON graph with organization, products, and FAQ
  const ldJsonGraph = createLdJsonGraph(
    Astro.locals.runtimeConfig.public,
    planProducts[0], // Use first plan as main entity
    {
      includeOrganization: true,
      includeBreadcrumbs: true,
      breadcrumbs: [
        { name: 'Home', url: getRelativeLocaleUrl(Astro.locals.locale, '/') },
        { name: 'Pricing', url: pricingUrl },
      ],
    },
  )

  // Add FAQ schema to the graph
  if (ldJsonGraph['@graph']) {
    ldJsonGraph['@graph'].push(faqSchema)
  }

  content['ldJSON'] = ldJsonGraph
}
---

<Layout content={content}
  ><section class="py-12 bg-gray-50 sm:py-16">
    <div class="px-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
      <div class="mx-auto mb-8 text-center sm:mb-24">
        <h1 class="text-3xl font-bold text-gray-900 sm:text-4xl xl:text-6xl font-pj">
          {m.plans_that_scale_with_your_business({}, { locale: Astro.locals.locale })}
        </h1>
        <p class="mt-6 text-xl font-normal text-gray-600 font-pj">
          {m.plans_that_scale_with_your_business_description({}, { locale: Astro.locals.locale })}
        </p>
      </div>

      {plans && plans.length > 0 && <Plans yearly={yearly} pricing={plans} />}

      <div class="flex items-center justify-center pb-12 mt-8 space-x-6 sm:pb-16">
        <div class="flex items-center">
          <input
            id="monthly"
            type="radio"
            checked={!yearly}
            name="pricing-plans"
            class="w-4 h-4 text-blue-600 border border-gray-200 focus:ring-1 focus:ring-blue-600 focus:outline-none"
          />
          <label for="monthly" class="block ml-3 text-sm font-medium text-gray-900 sm:text-base">
            {m.monthly_plan({}, { locale: Astro.locals.locale })}
          </label>
        </div>
        <div class="flex items-center">
          <input
            id="yearly"
            type="radio"
            checked={yearly}
            name="pricing-plans"
            class="w-4 h-4 text-blue-600 border border-gray-200 focus:ring-1 focus:ring-blue-600 focus:outline-none"
          />
          <label for="yearly" class="block ml-3 text-sm font-medium text-gray-900 sm:text-base">
            {m.yearly_plan({}, { locale: Astro.locals.locale })}
          </label>
          <span class="ml-1 text-sm font-medium text-blue-600">
            ({m.save({}, { locale: Astro.locals.locale })} 20%)
          </span>
        </div>
      </div>
      <div class="pb-24 sm:pb-32">
        <div class="px-6 mx-auto max-w-7xl lg:px-8">
          <h2 class="font-semibold text-center text-gray-900 text-lg/8">{m.trusted_by_the_biggest_capacitor_apps({}, { locale: Astro.locals.locale })}</h2>
          <div class="grid items-center max-w-lg grid-cols-2 mx-auto mt-10 gap-x-8 gap-y-10 sm:grid-cols-3 sm:gap-x-10 sm:max-w-2xl lg:grid-cols-5 lg:mx-0 lg:max-w-none">
            <div class="flex flex-col items-center space-y-2">
              <div class="bg-gray-100 shadow-sm rounded-2xl">
                <img class="object-contain w-12 h-12 rounded-xl grayscale" src="/nana-logo-transparent.webp" alt="Nana" width="48" height="48" />
              </div>
              <div class="text-center">
                <p class="text-sm font-medium text-gray-900">Nana</p>
                <p class="text-xs text-gray-500">2.5M {m.downloads({}, { locale: Astro.locals.locale })}</p>
              </div>
            </div>
            <div class="flex flex-col items-center space-y-2">
              <div class="bg-gray-100 shadow-sm rounded-2xl">
                <img class="object-contain w-12 h-12 rounded-xl grayscale" src="/snowqueen.webp" alt="Snowqueen" width="48" height="48" />
              </div>
              <div class="text-center">
                <p class="text-sm font-medium text-gray-900">Snowqueen</p>
                <p class="text-xs text-gray-500">1.8M {m.downloads({}, { locale: Astro.locals.locale })}</p>
              </div>
            </div>
            <div class="flex flex-col items-center space-y-2">
              <div class="bg-gray-100 shadow-sm rounded-2xl">
                <img class="object-contain w-12 h-12 rounded-xl grayscale" src="/shelf_app.webp" alt="Shelf" width="48" height="48" />
              </div>
              <div class="text-center">
                <p class="text-sm font-medium text-gray-900">Shelf</p>
                <p class="text-xs text-gray-500">950K {m.downloads({}, { locale: Astro.locals.locale })}</p>
              </div>
            </div>
            <div class="flex flex-col items-center space-y-2">
              <div class="bg-gray-100 shadow-sm rounded-2xl">
                <img class="object-contain w-12 h-12 rounded-xl grayscale" src="/suez.webp" alt="Suez" width="48" height="48" />
              </div>
              <div class="text-center">
                <p class="text-sm font-medium text-gray-900">Suez</p>
                <p class="text-xs text-gray-500">3.2M {m.downloads({}, { locale: Astro.locals.locale })}</p>
              </div>
            </div>
            <div class="flex flex-col items-center space-y-2">
              <div class="bg-gray-100 shadow-sm rounded-2xl">
                <img class="object-contain w-12 h-12 rounded-xl grayscale" src="/janitor_app.webp" alt="Janitor" width="48" height="48" />
              </div>
              <div class="text-center">
                <p class="text-sm font-medium text-gray-900">Janitor</p>
                <p class="text-xs text-gray-500">750K {m.downloads({}, { locale: Astro.locals.locale })}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <Enterprise />
      {credits && credits.length > 0 && <CreditPricing credits={credits} />}
      <!-- <Calculator /> -->
      <p class="max-w-md mx-auto mb-8 text-base text-center text-gray-500 md:mt-16 font-pj">
        {m.we_don_t_bill_you_automatically_until_your_confirmation({}, { locale: Astro.locals.locale })}<br />
        {m.we_don_t_store_or_sell_your_data_to_anyone({}, { locale: Astro.locals.locale })}
      </p>
    </div>
    <Faq />
  </section>
</Layout>
